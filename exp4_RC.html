<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>exp</title>
  <script src="jspsych-6.2.0/jspsych.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-fullscreen.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-image-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-survey-text.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-button-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-survey-likert.js"></script>
  <script src="js/jspsych-categorize-html-mat.js"></script>
  <script src="js/jspsych-iat-html-mat.js"></script>
  <script src="js/jspsych-html-mouse-response.js"></script>
  <script src="js/jquery.min.js"></script> <!-- https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js -->
  <script src="js/lodash.min.js"></script> <!-- https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js -->
  <script src="js/firebase.js"></script> <!-- https://www.gstatic.com/firebasejs/5.0.4/firebase.js -->
  <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css">
  <style>
    .stimulus {
      font-size: 32px;
    }

    .jspsych-content-wrapper {
      width: 900px !important;
      height: 700px !important;
    }

    .rcimg{
      cursor: pointer;
    }

    .rcimg {
      margin-top: 25px;
      margin-bottom: 25px;
      margin-left: 25px;
      margin-right: 25px;
    }

    .rcimg:hover {
      box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
    }
  </style>
</head>

<script>
  /* Parameters */
  var timeline = [];
  var qlink = "https://uclpsychology.co1.qualtrics.com/jfe/form/SV_87yt1jfLh9l4BUy";
  var numOfPairs = 70;  // Total number of pair images images (inv & ori)
  var cond = jsPsych.data.getURLVariable("cond");
  // if (cond == null) { cond = _.sampleSize(["bogus", "control"], 1)[0] };
  var id = jsPsych.data.getURLVariable("id");
  if (id == null) { id = jsPsych.randomization.randomID(15) };

  // Redirect if control condition ----------------------------------------------------------------------------------------
  if (cond == "control") window.location = qlink + "?id=" + id + "&cond=" + cond;


  // Fullscreen mode ------------------------------------------------------------------------------------------------------
  var activeFullscreen = {
    message: function () {
      html = "";
      return html;
    },
    button_label: "Veuillez cliquer ici pour activer le mode plein écran",
    type: 'fullscreen',
    fullscreen_mode: true,
    delay_after: 200,
  };

  // Instructions --------------------------------------------------------------------------------------------------------
  var inst1 = {
    type: "html-button-response",
    post_trial_gap: 300,
    choices: ['continuer'],
    stimulus: function () {
      var html = "";
      html += "<h1>Deuxième étude : Vos attitudes</h1>";
      html += "<p class='justify'>Cette deuxième étude est indépendante de la première et ";
      html += "est menée par quatre chercheurs internationaux des Pays-Bas, des États-Unis, d'Allemagne et de Belgique. "
      html += "Le but est de tester si les gens sont capables d'accéder à leur attitudes authentiques, ";
      html += "c'est-à-dire ce qu'ils pensent vraiment de certains groupes ou personnes.</br></br>";
      html += "Pour cela, vous passerez d'abord une nouvelle version du test de la <b>Corrélation Inverse</b> ";  
      html += "permettant de mesurer vos véritables attitudes personnelles à l'égard des personnes handicapées et des personnes âgées. ";
      html += "Par la suite, il vous sera demander de compléter un court questionnaire 'classique' ";
      html += "dans lequel vous devrez rapporter vos attitudes vis-à-vis de ces mêmes groupes.</br></br>";
      html += "En somme, cette deuxième étude vise à tester si vous êtes capable de rapporter vos <b>vraies</b> attitudes, ";
      html += "tel que mesuré par le test de la Corrélation Inverse.</p>";
      return html;
    }
  };

  // RC --------------------------------------------------------------------------------------------------------------------
  /* Generate RC trials */
  var imgsRC = _.range(1, numOfPairs + 1); // generate numerical sequence
  imgsRC = imgsRC.map(function (e) { return ['imgRC/faceOri' + e + '.jpg', 'imgRC/faceInv' + e + '.jpg'] });
  imgsRC = _.flattenDeep(imgsRC);
  imgsRC = _.chunk(imgsRC, 02); // 2 faces for each trials (1 ori + 1 inv)
  var RC_stim = [];
  imgsRC.map(function (e) { RC_stim.push({ trialImgs: e }) });
  var RCstim = RC_stim;
  var preloadimages = _.flattenDeep(imgsRC);
  preloadimages.push(['imgbogus/check.png', 'img/loading.gif']);
  preloadimages = _.flattenDeep(preloadimages);

  /* RC instructions */
  var RCinst_old = {
    type: "html-button-response",
    post_trial_gap: 200,
    choices: ['commencer'],
    stimulus: function () {
      var html = "";
      html += "<h1>Corrélation inverse : personnes âgées</h1>";
      html += "<p class = 'justify'>Dans cette tâche, plusieurs visages vous seront présentés. ";
      html += "Ces visages ont été bruités afin de préserver l'anonymat des personnes.</br></br>";
      html += "Votre tâche consiste à ";
      html += "<b>choisir le visage qui ressemble le plus à une <u>personne âgée</u></b> à chaque essai. ";
      html += "Utilisez la souris pour faire votre choix.</br></br>";
      html += "En moyenne, les participant·e·s prennent environ <b>1 seconde</b> par essai. ";
      html += "Essayez de maintenir un temps similaire. Il y a un total de " + numOfPairs + " essais.</br></br>";
      html += "Notez également que les visages peuvent se ressembler mais qu'ils sont en réalité différents. ";
      html += "Essayez de vous fier à votre <b>intuition</b> pour faire le meilleur choix.</br></br>";
      html += "Veuillez rester concentré·e.</p></br></br>";
      return html;
    }
  };

  /* RC */
  var i = 1;
  var RC_old = {
    timeline_variables: RCstim,
    repetitions: 1,
    randomize_order: true,
    post_trial_gap: 0,
    data: {
      task: 'RC_old',
    },
    timeline: [{
      type: 'html-mouse-response',
      on_load: function () {
          // $('.jspsych-content').css({ "max-width": "100%" });
      },
      stimulus: function () {
        html = "";
        html += "<p>choisissez le visage qui ressemble le plus à une <b>personne âgée</b> :</p>";
        jsPsych.timelineVariable('trialImgs', true).map(function (e) {
          html += "<img class='rcimg' src='" + e + "'>";
        });
        html += "</br>Essai : " + i + "/" + numOfPairs + "</br>";
        i += 1;
        return html;
      },
    }]
  };


  var RCinst_disabled = {
    type: "html-button-response",
    post_trial_gap: 200,
    choices: ['commencer'],
    stimulus: function () {
      var html = "";
      html += "<h1>Corrélation inverse : personnes handicapées</h1>";
      html += "<p class = 'justify'>Nous vous demandons à présent de passer à nouveau la tâche de la corrélation inverse ";
      html += "mais cette fois au lieu de choisir le visage qui ressemble le plus à une personne âgée, ";
      html += "vous devrez choisir celui qui ressemble le plus à une <b><u>personne handicapée</u></b>.</br></br>"
      html += "Le reste des instructions restent les mêmes.</p></br></br>";
      return html;
    }
  };

  /* RC */
  var ii = 1;
  var RC_disabled = {
    timeline_variables: RCstim,
    repetitions: 1,
    randomize_order: true,
    post_trial_gap: 0,
    data: {
      task: 'RC_disabled',
    },
    timeline: [{
      type: 'html-mouse-response',
      on_load: function () {
          // $('.jspsych-content').css({ "max-width": "100%" });
      },
      stimulus: function () {
        html = "";
        html += "<p>choisissez le visage qui ressemble le plus à une <b>personne handicapée</b> :</p>";
        jsPsych.timelineVariable('trialImgs', true).map(function (e) {
          html += "<img class='rcimg' src='" + e + "'>";
        });
        html += "</br>Essai : " + ii + "/" + numOfPairs + "</br>";
        ii += 1;
        return html;
      },
    }]
  };

  // Instructions --------------------------------------------------------------------------------------------------------
  var inst2 = {
    type: 'html-keyboard-response',
    choices: jsPsych.NO_KEYS,
    trial_duration: 1000 * 25,
    stimulus: function () {
      var html = "";
      html += "<h1>Corrélation Inverse - Calibrage</h1>";
      html += "<p class='justify'>Sur base de vos réponses, nous vérifions maintenant que le test de la corrélation inverse a été ";
      html += "calibré correctement pour mesurer vos véritables attitudes envers les personnes âgées et les personnes handicapées.</br></br>";
      html += "Si le calibrage échoue, il vous sera demandé de faire quelques essais supplémentaires pour calibrer davantage la mesure. ";
      html += "Si le calibrage est réussi, vous serez redirigé vers la deuxième partie de cette étude.</br></br>";
      html += "Veuillez patienter quelques secondes pendant que le programme effectue le calcul...</p></br>";
      html += "<img src ='img/loading2.gif' width = '80px'>";
      return html;
    }
  };

  var inst3 = {
    type: "html-button-response",
    post_trial_gap: 300,
    choices: ['continuer'],
    stimulus: function () {
      var html = "";
      html += "<h1>Corrélation Inverse - Résultat du calibrage</h1>";
      html += "<p class='justify'>Le calibrage a réussi à mesurer vos véritables attitudes envers deux groupes sociaux, ";
      html += "à savoir les personnes âgées et les personnes handicapées.</p></br>";
      html += "<img src='imgbogus/check.png' width = '80px'></br></br>";
      return html;
    }
  };

  var inst4 = {
    type: "html-button-response",
    post_trial_gap: 300,
    choices: ['continuer'],
    stimulus: function () {
      var html = "";
      html += "<h1>Comment fonctionne la Corrélation Inverse ?</h1>";
      html += "<p class='justify'>Les recherches ont montré que cette tâche de la Corrélation Inverse fournit une mesure très précise des ";
      html += "attitudes authentiques d'une personne. ";
      html += "Il s'agit de l'outil le plus proche du détecteur de mensonges disponible aujourd'hui ";
      html += "pour déterminer vos véritables attitudes.</br></br>";
      html += "Par exemple, des chercheurs des universités de Harvard (M. Banaji), Stanford (J. Eberhardt), Princeton (S. Fiske) ";
      html += "l'ont utilisé pour mesurer les attitudes authentiques des personnes à l'égard de groupes et ont montré ";
      html += "que ces réponses prédisaient le comportement mieux que toute autre mesure psychologique.</br></br>";
      html += "Comme on vous demande de répondre très rapidement et que les visages sont ambigus, ";
      html += " vous n'avez aucun contrôle sur votre réponse. ";
      html += "C'est pourquoi la mesure est fiable et vous donne accès à vos véritables attitudes, ";
      html += "sans les diverses stratégies visant à cacher les 'vrais' sentiments sous-jacents ";
      html += "(par exemple, porter un jugement positif pour donner une bonne image de soi).</br></br>";
      html += "Vous allez maintenant être redirigé vers le questionnaire 'classique'.</p>";
      return html;
    },
  };


  /*  ~~~~~~~~~~~~~~~~ TIMELINES  ~~~~~~~~~~~~~~~~ */
  timeline.push(activeFullscreen);
  timeline.push(inst1);
  timeline.push(RCinst_old);
  timeline.push(RC_old);
  timeline.push(RCinst_disabled);
  timeline.push(RC_disabled);
  timeline.push(inst2);
  timeline.push(inst3);
  timeline.push(inst4);


  /*  ~~~~~~~~~~~~~~~~ INITIALISE EXP  ~~~~~~~~~~~~~~~~ */
  jsPsych.init({
    timeline: timeline,
    max_load_time: 60 * 1000,
    preload_images: preloadimages,
    // exclusions: {
    //   min_width: 800,
    //   min_height: 600,
    // },
    on_interaction_data_update: function (data) {
      //console.log(JSON.stringify(data)); // focus/blur data
    },
    on_finish: function (data) {
      $("#jspsych-content").html("<img src='img/loading2.gif'>");

      /* Initialize Firebase */
      var config = {
        apiKey: "AIzaSyD4r9uWI4icto61fm2tC9neKdEiOUWzMJ8",
        databaseURL: "https://biatw-68fe6.firebaseio.com/"
      };

      firebase.initializeApp(config);
      var database = firebase.database();

      /* Qualtrics url parameters */
      qlink += "?id=" + id;
      qlink += "&cond=" + cond;
      qlink += "&jsTime=" + jsPsych.totalTime();

      /* jsPsych: add data to every trial */
      jsPsych.data.addProperties({
        id: id,
        cond: cond,
      });

      //jsPsych.data.displayData();

      var dataIAT = data.filter({ task: 'IAT' }).csv();

      /* Send data to Firebase and redirect to Qualtrics */
      database.ref("bogus/IAT/" + id + "/")
        .update({ dataIAT })
        .then(function () {
          console.log("dataAll sent!");
          window.location = qlink; // redirect to qualtrics
        });
    }
  });
</script>

</html>