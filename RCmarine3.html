<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>exp</title>
    <script src="jspsych-6.0.3/jspsych.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-survey-text.js"></script>
    <script src="js/jspsych-html-mouse-response.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/lodash.min.js"></script>
    <script src="js/firebase.js"></script>
    <link href="jspsych-6.0.3/css/jspsych.css" rel="stylesheet" type="text/css">
    <style>
    body {
        cursor: default;
    }
    .rcimg-12 {
        cursor: pointer;
    }
    .rcimg-12 {
        margin: 10px;
    }
    .rcimg-12:hover {
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
    }
    .jspsych-content-wrapper {
        width: 900px;
        height: 700px;
    }
</style>
</head>

<body></body>

<script>
    /* Parameters */
    var numOfPairs = 150*6; // Total number of pair images images (inv & ori)
    var qlink = 'https://uclpsychology.co1.qualtrics.com/jfe/form/SV_4IUHRh9PASL8VuJ';
    var FBdirectory = 'RCmarine3'; // Firebase directory

    /* Functions */
    // Return image link
    var imgLink = function(imgNum, oriInv) {
        if(oriInv == "inv") {
            return 'https://marinerougier.github.io/CIs_Expe5_VAASTRC_Inv/faceInv' + imgNum + '.png?raw=1'
        } else {
            return 'https://marinerougier.github.io/CIs_Expe5_VAASTRC_Ori/faceOri' + imgNum + '.png?raw=1'
        };
    };

    // Flatten array
    function flatten(arr) {
        return arr.reduce(function(flat, toFlatten) {
            return flat.concat(Array.isArray(toFlatten) ? flatten(toFlatten) : toFlatten);
        }, []);
    };

    /* Initial variables */
    var timeline = [];
    var preloadimagesRC = [];
    var id = jsPsych.data.getURLVariable("id");
    var colorOrder = jsPsych.data.getURLVariable("colorOrder");

    /* Generate RC trials */
    var imgsRC = $.map($(Array(numOfPairs)), function(val, i) {return i + 1;}); // generate numerical sequence
    imgsRC.map(function(e) {
        preloadimagesRC.push(imgLink(e, 'ori'));
        preloadimagesRC.push(imgLink(e, 'inv'));
    });

    var genFacesPerSlide = function(numOfFacesPerTrial, imgs) {
        numOfFacesPerTrial = numOfFacesPerTrial / 2;

        var chunkedArray = [];

        var i, j, trialImgs, chunk = numOfFacesPerTrial;
        for (i = 0, j = imgs.length; i < j; i += chunk) {

            trialImgs = imgs.slice(i, i + chunk);

            var tempOri = [];
            var tempInv = [];

            trialImgs.map(function(e) {
                tempOri.push(imgLink(e, 'ori'));
                tempInv.push(imgLink(e, 'inv'));
            });

            trialImgs = flatten([tempOri, tempInv]);
            // trialImgs = _.shuffle(trialImgs); // randomize order in slide

            chunkedArray.push({
                trialImgs
            });
        }
        return chunkedArray;
    };

    var RCstim = genFacesPerSlide(12, imgsRC); // RC fast-12: 250 trials (6 ori + 6 anti = 12  faces per trial)

    // EXPERIMENT -----------------------------------------------------------------------------------------------------------------
    /* Randomize RC order */
    var genColor = function(colorID, colorName) {return "<span style='color:"+ colorID+"'><b>"+colorName+"</b></span>"};

    var colorOrder = colorOrder == null ? _.sample(["blueFirst", "yellowFirst"]) : colorOrder;

    if(colorOrder == "blueFirst") {
        var color1 = genColor("#2a57ea", "bleu");
        var color2 = genColor("#b5a21b", "jaune");
        var color1name = "bleu";
        var color2name = "jaune";
    } else {
        var color1 = genColor("#b5a21b", "jaune");
        var color2 = genColor("#2a57ea", "bleu");
        var color1name = "jaune";
        var color2name = "bleu";
    };

    /* Instructions and Fullscreen mode */
    var activateFullscreen = {
        type: 'fullscreen',
        fullscreen_mode: true,
        delay_after: 500,
        message: "",
        button_label: "Veuillez cliquer ici pour passer au mode plein écran",
    };

    /* Get participant ID */
    var getID = {
        type: 'survey-text',
        questions: [{prompt: "Merci de reporter ci-dessous EN MAJUSCULE le code </br>" + 
        "qui vous a été donné sur la feuille placée devant vous :", rows: 1, columns: 10}],
        button_label: "Continuer",
        on_finish: function(data) {
            jsPsych.data.addProperties({
                id: JSON.parse(data.responses)["Q0"],
            });
        },
    };

    var loopGetID = { 
        timeline: [getID], 
        loop_function: function(data){ 
            var id = jsPsych.data.getLastTrialData().select('responses').values[0]; 
            var id = JSON.parse(id).Q0; 
            if(id == ""){ 
              alert("Veuillez reporter votre code"); 
                return true; 
            } else { 
                return false; 
            } 
        },
    }; 

    /* RC instructions */
    var RCinst1 = {
        type: "html-keyboard-response",
        stimulus: function() {
            var html = "";
            html += "<h1>Tâche 2</h1>";
            html += "<p class = 'justify'>Vous devez savoir que chaque groupe de visage que vous avez vu dans la tâche précédente ";
            html += "(les visages avec un fond " + color1  +" et ceux avec un fond " + color2 + ") ";
            html += "était en fait très différent de l'autre groupe.</br></br>";
            html += "De plus, dans chaque groupe, les visages partagent une série de caractéristiques physiques ";
            html += "les rendant similaires entre eux.</p>";
            html += "<p>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour continuer</p>";
            return html;
        },
        choices: [32],
    };

    var RCinst2 = {
        type: "html-keyboard-response",
        stimulus: function() {
            var html = "";
            html += "<h1>Tâche 2</h1>";
            html += "<p class = 'justify'>Dans cette tâche, nous allons vous présenter, à travers de nombreux essais, ";
            html += "des visages similaires à l’exemple présenté ci-dessous. ";
            html += "A chaque essai, nous vous présenterons 12 visages. ";
            html += "A nouveau, ces visages ont été délibérément floutés, mais cette fois-ci de manière différente. ";
            html += "En conséquence ces 12 visages sembleront similaires entre eux.</p>";
            html += "<img width='200' style='padding: 0px' src='" + imgLink(474, 'ori') + "'>";
            html += "<p>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour continuer</p>";
            return html;
        },
        choices: [32],
    };

    var RCinst3a = {
        type: "html-keyboard-response",
        stimulus: function() {
            var html = "";
            html += "<h1>Tâche 2</h1>";
            html += "<p class = 'justify'>A chaque essai, votre tâche est de sélectionner, ";
            html += "parmi les 12 options de réponses, le visage ";
            html += "que vous trouvez le plus similaire au groupe de visages qui avait un fond " + color1 + " ";
            html += "dans la tâche précédente.</p>";
            html += "<img width='200' style='padding: 0px' src='" + imgLink(474, 'ori') + "'>";
            html += "<p class = 'justify'>Pour cela, vous devrez cliquer (avec la souris) ";
            html += "a chaque essai sur le visage que vous voulez choisir.</p></br></br>";
            html += "<p>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour continuer</p>";
            return html;
        },
        choices: [32],
    };

    var RCinst3b = {
        type: "html-keyboard-response",
        stimulus: function() {
            var html = "";
            html += "<h1>Tâche 2</h1>";
            html += "<p class = 'justify'>A chaque essai, votre tâche est de sélectionner, ";
            html += "parmi les 12 options de réponses, le visage ";
            html += "que vous trouvez le plus similaire au groupe de visages qui avait un fond " + color2 + " ";
            html += "dans la tâche précédente.</p>";
            html += "<img width='200' style='padding: 0px' src='" + imgLink(474, 'ori') + "'>";
            html += "<p class = 'justify'>Pour cela, vous devrez cliquer (avec la souris) ";
            html += "a chaque essai sur le visage que vous voulez choisir.</p></br></br>";
            html += "<p>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour continuer</p>";
            return html;
        },
        choices: [32],
    };

    var RCinst4 = {
        type: "html-keyboard-response",
        stimulus: function() {
            var html = "";
            html += "<h1>Tâche 2</h1>";
            html += "<p class = 'justify'>Avant de commencer : </br></br>";
            html += "<b>Notez qu'il n'y a pas de bonnes ou mauvaises réponses.</b> ";
            html += "Vous devez juste répondre aussi <b>intuitivement</b> que possible. ";
            html += "Notez qu'en moyenne, à chaque essai, les participants mettent <b>3 secondes</b> ";
            html += "pour sélectionner un visage. Merci d’essayer autant que possible de <b>respecter ce temps</b>.</br></br>";
            html += "Dans ce bloc, vous devrez effectuer un total de 150 essais.</p></br></br>";
            html += "<p>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour continuer</p>";
            return html;
        },
        choices: [32],
    };

    var RCinst5 = {
        type: "html-keyboard-response",
        stimulus: function() {
            var html = "";
            html += "<p class = 'justify'>Le premier bloc est maintenant terminé.</br>";
            html += "Vous allez passer au deuxième bloc.";
            html += "<p>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour continuer</p>";
            return html;
        },
        choices: [32],
    };

    /* RC */
    var i = 1;
    var RC1 = {
        timeline_variables: RCstim,
        randomize_order: true,
        //sample: {
        //    type: 'custom',
        //    fn: function(t) {return [1, 2, 3]}
        //},
        data: {
            task: 'RC1',
            background: color1name,
            RCcolor: 'first',
            colorOrder: colorOrder
        },
        timeline: [{
            type: 'html-mouse-response',
            stimulus: function() {
                html = "";
                html += "<p>Choisissez le visage qui vous semble le plus similaire au groupe de visage </br>";
                html += "qui avait un fond " + color1 + " dans la tâche précédente : </br></br>";
                jsPsych.timelineVariable('trialImgs', true).map(function(e) {
                    html += "<img class='rcimg-12' src='" + e + "'>";
                });
                html += "</br> Essai : " + i + "/150</br>";
                i += 1;
                return html;
            },
        }]
    };

    var ii = 1;
    var RC2 = {
        timeline_variables: RCstim,
        randomize_order: true,
        //sample: {
        //    type: 'custom',
        //    fn: function(t) {return [1, 2, 3]}
        //},
        data: {
            task: 'RC2',
            background: color2name,
            RCcolor: 'second',
            colorOrder: colorOrder
        },
        timeline: [{
            type: 'html-mouse-response',
            stimulus: function() {
                html = "";
                html += "<p>Choisissez le visage qui vous semble le plus similaire au groupe de visage </br>";
                html += "qui avait un fond " + color2 + " dans la tâche précédente : </br></br>";
                jsPsych.timelineVariable('trialImgs', true).map(function(e) {
                    html += "<img class='rcimg-12' src='" + e + "'>";
                });
                html += "</br> Essai : " + ii + "/150</br>";
                ii += 1;
                return html;
            },
        }]
    };


    /*  ~~~~~~~~~~~~~~~~ TIMELINES  ~~~~~~~~~~~~~~~~ */
    timeline.push(activateFullscreen);
    timeline.push(loopGetID);
    timeline.push(RCinst1);
    timeline.push(RCinst2);
    timeline.push(RCinst3a); // repeat after first block
    timeline.push(RCinst4); // repeat after first block
    timeline.push(RC1);
    timeline.push(RCinst5); // in between blocks
    timeline.push(RCinst3b); // repeat after first block
    timeline.push(RCinst4); // repeat after first block
    timeline.push(RC2);

    /* start the experiment */
    jsPsych.init({
        timeline: flatten(timeline),
        preload_images: preloadimagesRC,
        max_load_time: 1000 * 500,
        exclusions: {
            min_width: 900,
            min_height: 700,
        },
        on_finish: function(data) {
            $("#jspsych-content").html("<img src='https://i.gifer.com/4V0b.gif'>");

            /* Initialize Firebase */
            var config = {
                apiKey: "AIzaSyBwDr8n-RNCbBOk1lKIxw7AFgslXGcnQzM",
                databaseURL: "https://marineexpe.firebaseio.com/"
            };

            firebase.initializeApp(config);
            var database = firebase.database();

            // if no id provided, generate a new id
            // if(id == null) {id = jsPsych.randomization.randomID(15)};
            id = jsPsych.data.get().select('id').values[0];

            /* Qualtrics url parameters */
            qlink += "?id="           + id;
            qlink += "&colorOrder="   + colorOrder;

            /* jsPsych: add data to every trial */
            jsPsych.data.addProperties({
                id: id,
            });

            var data =  jsPsych.data.get().filterCustom(function(x){
                return x.task == "RC1" || x.task == "RC2"
            }).csv();

            /* Send data to Firebase and redirect to Qualtrics */
            database
            .ref(FBdirectory + "/" + id + "/")
            .update({data})
            .then(function(){
                console.log("Data sent!");
                window.location.href = qlink;
                //jsPsych.data.displayData();
            });
        }
    });
</script>

</html>