<!-- TO DO -->
<!-- WINDOW RESTRICTION! -->

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>exp</title>
    <script src="jspsych-6.0.3/jspsych.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-survey-multi-choice.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-survey-text.js"></script>
    <script src="js/jspsych-iat-html-mat.js"></script>
    <script src="js/jspsych-html-mouse-response.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/lodash.min.js"></script>
    <script src="js/firebase.js"></script>
    <link href="jspsych-6.0.3/css/jspsych.css" rel="stylesheet" type="text/css">
    <style>
        body {
            cursor: default;
        }

        .rcimg-02,
        .rcimg-12 {
            cursor: pointer;
        }

        .rcimg-02 {
            margin-top: 25px;
            margin-bottom: 25px;
            margin-left: 5px;
            margin-right: 5px;
        }

        .rcimg-12 {
            margin: 10px;
        }

        .rcimg-02:hover,
        .rcimg-12:hover {
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        }

        .jspsych-content-wrapper {
            width: 900px;
            height: 700px;
        }

        .iat_color_black {
            color: black;
        }

        .iat_color_green {
            color: green;
        }
    </style>
</head>

<body></body>

<script>
    /* Parameters */
    var numOfPairsRC02 = 550;  // Total number of pair images images (inv & ori)
    var numOfPairsRC12 = 1500; // Total number of pair images images (inv & ori)
    var qlink = 'https://uclpsychology.co1.qualtrics.com/jfe/form/SV_eFM8wo1wCZbiWAB';

    /* Initial variables */
    var timeline = [];
    var preloadimagesRC12 = [];
    var preloadimagesRC02 = [];
    var id = jsPsych.data.getURLVariable("id");
    var cond = jsPsych.data.getURLVariable("cond");

    // Consent ---------------------------------------------------------------------------------------------------------------
    /* Fullscreen mode */
    var activeFullscreen = {
        message: function () {
            html = "";
            html += "<h1>CONSENTEMENT ÉCLAIRÉ</h1>";
            html += "<p class='justify'>Merci de votre intérêt et de votre participation à cette étude ";
            html += "administrée par Mathias Schmitz et Marine Rougier. ";
            html += "L'expérience dure approximativement 30 minutes.</br></br>";
            html += "Vous avez le droit de vous retirer de l'expérience à tout moment, ";
            html += "sans devoir vous justifier et sans subir aucun préjudice. Nous vous rappelons également ";
            html += "que si vous vous retirez de l'étude, vous conserverez le bénéfice obtenu des crédits ";
            html += "attribués pour cette participation. Par ailleurs, nous garantissons également la ";
            html += "confidentialité et l'anonymat de vos réponses. Des informations complémentaires peuvent ";
            html += "être obtenues à tout moment auprès du chercheur responsable.</br></br>";
            html += "Sachez que vous pouvez contacter Monsieur Jan de Mol pour rapporter ou discuter ";
            html += "des problèmes liés à votre participation à la recherche.</p>";
            return html;
        },
        button_label: "Je donne mon consentement libre et éclairé pour participer en tant que sujet à cette recherche",
        type: 'fullscreen',
        fullscreen_mode: true,
        delay_after: 200,
    };

    // RC ---------------------------------------------------------------------------------------------------------------
    /* Generate RC trials */
    var imgsRC02 = _.range(1, numOfPairsRC02 + 1); // generate numerical sequence
    var imgsRC12 = _.range(1, numOfPairsRC12 + 1); // generate numerical sequence

    imgsRC02 = imgsRC02.map(function (e) { return ['imgIAT/faceOri' + e + '.png', 'imgIAT/faceInv' + e + '.png'] });
    imgsRC12 = imgsRC12.map(function (e) { return ['imgIAT/faceOri' + e + 's.png', 'imgIAT/faceInv' + e + 's.png'] });

    imgsRC02 = _.flattenDeep(imgsRC02);
    imgsRC12 = _.flattenDeep(imgsRC12);

    preloadimagesRC02 = imgsRC02;
    preloadimagesRC12 = imgsRC12;

    // imgsRC = _.shuffle(imgsRC); // full randomization
    // imgsRC = _.flattenDeep(_.shuffle(_.chunk(imgsRC12, 2))); // full randomization but keep inv ori in the same trial
    imgsRC12 = _.chunk(imgsRC12, 12); // 250 trials (6 ori + 6 anti = 12  faces per trial)
    imgsRC02 = _.chunk(imgsRC02, 02); // 550 trials (1 ori + 1 inv per trial)

    var RC02_stim = [];
    var RC12_stim = [];
    imgsRC02.map(function (e) { RC02_stim.push({ trialImgs: e }) });
    imgsRC12.map(function (e) { RC12_stim.push({ trialImgs: e }) });

    /* Randomize RC conditions */
    var RCcondition = cond != null ? cond : _.sample(["RC02", "RC12"]);

    /* RC instructions & fullscreen */
    switch (RCcondition) {
        case "RC02":
            var estimatedTimePerTrial = "1 seconde";
            var cssRC = "rcimg-02";
            var imgWidth = 512;
            var RCstim = RC02_stim;
            var numOfPairs = numOfPairsRC02;
            var preloadimages = preloadimagesRC02;
            break;
        case "RC12":
            var estimatedTimePerTrial = "3 secondes";
            var cssRC = "rcimg-12";
            var imgWidth = 150;
            var RCstim = RC12_stim;
            var numOfPairs = numOfPairsRC12 / 6;
            var preloadimages = preloadimagesRC12;
            break;
    };

    var RCinst = {
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function () {
            var html = "";
            html += "<h1>Catégorisation des visages</h1>";
            html += "<p class = 'justify'>Dans cette tâche, plusieurs visages vous seront présentés. ";
            html += "Ces visages ont été bruités afin de préserver l'anonymat des personnes.</br></br>";
            html += "Votre tâche consiste à ";
            html += "<b>choisir le visage qui ressemble le plus à une personne d'origine maghrébine</b></br>";
            html += " (autrement dit, le visage le plus « maghrébin ») à chaque essai. ";
            html += "Utilisez la souris pour faire votre choix.</br></br>";
            html += "En moyenne, les participant·e·s prennent environ <b>" + estimatedTimePerTrial + "</b> par essai. ";
            html += "Essayez de maintenir un temps similaire.</br></br>"
            html += "Notez également que les visages peuvent se ressembler mais qu'ils sont en réalité différents. ";
            html += "Essayez de vous fier à votre <b> intuition</b> pour faire le meilleur choix.</br></br>";
            html += "Veuillez rester concentré·e.</p>";
            html += "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour commencer</p>";
            return html;
        }
    };

    /* RC */
    var i = 1;
    var RC = {
        timeline_variables: RCstim.slice(0,5),
        repetitions: 1,
        randomize_order: false,
        data: {
            cond: RCcondition,
            task: 'RC',
            numOfPairs: numOfPairs
        },
        timeline: [{
            type: 'html-mouse-response',
            on_load: function () {
                if (RCcondition == 'RC02') {
                    $('.jspsych-content-wrapper').css({ "width": "1100px" });
                    $('.jspsych-content').css({ "max-width": "100%" });
                };
            },
            stimulus: function () {
                html = "";
                html += "<p>choisissez le visage qui vous semble le plus <b>« maghrébin »</b> :</p>";
                jsPsych.timelineVariable('trialImgs', true).map(function (e) {
                    html += "<img class='" + cssRC + "' src='" + e + "'>";
                });
                html += "</br>Essai : " + i + "/" + numOfPairs + "</br>";
                i += 1;
                return html;
            },
        }]
    };

    // IAT --------------------------------------------------------------------------------------------------------------
    // parameters
    var left_key = "S";
    var right_key = "L";
    var label_good_bad = ['bon', 'mauvais'];
    var label_black_white = ['Maghrébin', 'Français'];

    var IATstims_black = [
        { categories: "black_white", category: label_black_white[0], stimulus: "Mustafa" },
        { categories: "black_white", category: label_black_white[0], stimulus: "Farid" },
        { categories: "black_white", category: label_black_white[0], stimulus: "Zahir" },
        { categories: "black_white", category: label_black_white[0], stimulus: "Youssef" },
        { categories: "black_white", category: label_black_white[0], stimulus: "Kader" },
        { categories: "black_white", category: label_black_white[0], stimulus: "Hassan" },
        { categories: "black_white", category: label_black_white[0], stimulus: "Ahmed" },
        { categories: "black_white", category: label_black_white[0], stimulus: "Mustafa" },
        { categories: "black_white", category: label_black_white[0], stimulus: "Hamid" },
        { categories: "black_white", category: label_black_white[0], stimulus: "Ali" },
    ];

    var IATstims_white = [
        { categories: "black_white", category: label_black_white[1], stimulus: "Benoît" },
        { categories: "black_white", category: label_black_white[1], stimulus: "Thibault" },
        { categories: "black_white", category: label_black_white[1], stimulus: "Blaise" },
        { categories: "black_white", category: label_black_white[1], stimulus: "Bastien" },
        { categories: "black_white", category: label_black_white[1], stimulus: "Gautier" },
        { categories: "black_white", category: label_black_white[1], stimulus: "Rémy" },
        { categories: "black_white", category: label_black_white[1], stimulus: "Matthieu" },
        { categories: "black_white", category: label_black_white[1], stimulus: "Fabrice" },
        { categories: "black_white", category: label_black_white[1], stimulus: "Sylvain" },
        { categories: "black_white", category: label_black_white[1], stimulus: "Clément" },
    ];

    var IATstims_good = [
        { categories: "good_bad", category: label_good_bad[0], stimulus: "amour" },
        { categories: "good_bad", category: label_good_bad[0], stimulus: "magnifique" },
        { categories: "good_bad", category: label_good_bad[0], stimulus: "plaisir" },
        { categories: "good_bad", category: label_good_bad[0], stimulus: "rires" },
        { categories: "good_bad", category: label_good_bad[0], stimulus: "merveilleux" },
        { categories: "good_bad", category: label_good_bad[0], stimulus: "joie" },
        { categories: "good_bad", category: label_good_bad[0], stimulus: "heureux" },
        { categories: "good_bad", category: label_good_bad[0], stimulus: "paix" },
        { categories: "good_bad", category: label_good_bad[0], stimulus: "liberté" },
        { categories: "good_bad", category: label_good_bad[0], stimulus: "vacances" },
    ];

    var IATstims_bad = [
        { categories: "good_bad", category: label_good_bad[1], stimulus: "blessure" },
        { categories: "good_bad", category: label_good_bad[1], stimulus: "épouvantable" },
        { categories: "good_bad", category: label_good_bad[1], stimulus: "horrible" },
        { categories: "good_bad", category: label_good_bad[1], stimulus: "mal" },
        { categories: "good_bad", category: label_good_bad[1], stimulus: "affreux" },
        { categories: "good_bad", category: label_good_bad[1], stimulus: "échec" },
        { categories: "good_bad", category: label_good_bad[1], stimulus: "méchant" },
        { categories: "good_bad", category: label_good_bad[1], stimulus: "douleur" },
        { categories: "good_bad", category: label_good_bad[1], stimulus: "prison" },
        { categories: "good_bad", category: label_good_bad[1], stimulus: "malade" },
    ];

    var IATstims_blackWhite = _.flattenDeep([IATstims_black, IATstims_white]);
    var IATstims_goodBad = _.flattenDeep([IATstims_good, IATstims_bad]);

    // block    trials  Function        Left key        Right key
    // 1        20      Practice        White           Black
    // 2        20      Practice        Good            Bad
    // 3        20      Practice        Good & White    Bad & Black
    // 4        40      Test            Good & White    Bad & Black
    // 5        20      Practice        Black           White
    // 6        20      Practice        Good & Black    Bad & White
    // 7        40      Test            Good & Black    Bad & White
    // Note. For half the subjects, the positions of Blocks 1, 3, and 4 are 
    // switched with those of Blocks 5, 6, and 7, respectively. 
    // The procedure in Blocks 3, 4, 6, and 7 is to alternate trials that present either 
    // a pleasant or an unpleasant word with trials that presented either a White or Black image.


    // dscore = rating * cond * time + (1 | id)

    // keys html
    var left_key_html = "<span class='light-keys'><kbd>" + left_key + "</kbd></span>";
    var right_key_html = "<span class='light-keys'><kbd>" + right_key + "</kbd></span>";

    // randomize label side
    label_good_bad = _.shuffle(label_good_bad);
    label_black_white = _.shuffle(label_black_white);

    // generate labels
    var block_1_label_left = label_black_white[0];
    var block_1_label_right = label_black_white[1];

    var block_2_label_left = label_good_bad[0];
    var block_2_label_right = label_good_bad[1];

    var block_3_label_left_top = label_black_white[0];
    var block_3_label_left_bot = label_good_bad[0];
    var block_3_label_right_top = label_black_white[1];
    var block_3_label_right_bot = label_good_bad[1];

    var block_4_label_left_top = block_3_label_left_top;
    var block_4_label_left_bot = block_3_label_left_bot;
    var block_4_label_right_top = block_3_label_right_top;
    var block_4_label_right_bot = block_3_label_right_bot;

    var block_5_label_left = label_black_white[1];
    var block_5_label_right = label_black_white[0];

    var block_6_label_left_top = label_black_white[1];
    var block_6_label_left_bot = label_good_bad[0];
    var block_6_label_right_top = label_black_white[0];
    var block_6_label_right_bot = label_good_bad[1];

    var block_7_label_left_top = block_6_label_left_top;
    var block_7_label_left_bot = block_6_label_left_bot;
    var block_7_label_right_top = block_6_label_right_top;
    var block_7_label_right_bot = block_6_label_right_bot;

    // general instructions
    var IATinst_1 = {
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function () {
            var html = "";
            html += "<h1>Tâche de catégorisation de mots et prénoms</h1>";
            html += "<p class='justify'>Dans la tâche suivante, un ensemble de mots ou prénoms vous sera présenté et ";
            html += "vous devrez classer ceux-ci dans des groupes. ";
            html += "Dans cette tâche, vous devrez classer ces mots/prénoms aussi <b>vite</b> que possible que vous pouvez ";
            html += "tout en essayant de faire le <b>moins d’erreurs possible</b>. Aller trop lentement ou ";
            html += "faire trop d’erreurs rendra votre résultat ininterprétable.</br></br>";
            html += "Comme vous le verrez, vous devrez classer les mots en fonction du fait qu'ils soient bons ou mauvais. ";
            html += "Aussi, vous devrez classer les prénoms en fonction du fait qu’ils soient d’origine maghrébine ou française. ";
            html += "Sur la slide suivante nous vous présenterons ces catégories de mots et de prénoms.</p></br>";
            html += "<h3 style='text-align: left'>Gardez à l’esprit</h3>";
            html += "<p class='justify'>•	Les deux labels en haut de votre écran vous indiquerons quels mots ou ";
            html += "prénoms vont avec chaque touche.</br>";
            html += "•	Gardez votre index gauche sur la touche <span class='light-keys'><kbd>S</span> et le droit ";
            html += "sur la touche <span class='light-keys'><kbd>L</span> afin de pouvoir répondre rapidement.</br>";
            html += "•	Chaque mot ou prénom a une classification correcte. La plupart de celles-ci sont faciles.</br>";
            html += "•	Essayez d’aller le plus vite possible.</br>";
            html += "•	Attendez-vous à faire quelques erreurs parce que vous allez vite. Ce n’est pas grave.</p>"
            html += "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour continuer</p>";
            return html;
        },
        on_load: function () {
            $('.jspsych-content-wrapper').css({ "width": "900px" });
            $('.jspsych-content').css({ "max-width": "90%" });
        },
    };

    var IATinst_2 = {
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function () {
            var html = "";
            html += "<h1>Tâche de catégorization de mots et prénoms</h1>";
            html += "<p class='justify'><center>Voici les quatre catégories et les mots/prénoms appartenant à chaque catégorie :</center></p></br>";
            html += "<table>";
            html += "<tr>";
            html += "<th width='200px'>Catégorie</th>";
            html += "<th align='left'>Mot/prénom</th>";
            html += "</tr>";
            html += "<tr>";
            html += "<td>Bon</td>";
            html += "<td align='left'>" + IATstims_good.map(function (e) { return e.stimulus; }).join(", ") + "</td>";
            html += "</tr>";
            html += "<tr>";
            html += "<td>Mauvais</td>";
            html += "<td align='left'>" + IATstims_bad.map(function (e) { return e.stimulus; }).join(", ") + "</td>";
            html += "</tr>";
            html += "<tr>";
            html += "<td>Maghrébin</td>";
            html += "<td align='left'>" + IATstims_black.map(function (e) { return e.stimulus; }).join(", ") + "</td>";
            html += "</tr>";
            html += "<tr>";
            html += "<td>Français</td>";
            html += "<td align='left'>" + IATstims_white.map(function (e) { return e.stimulus; }).join(", ") + "</td>";
            html += "</tr>";
            html += "</table>";
            html += "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour continuer</p>";
            return html;
        }
    };

    // blocks instructions
    var IATinst_block_1 = {
        type: 'html-keyboard-response',
        choices: [32],
        stimulus: "<table class='iat_table' style='width: 100%; table-layout: fixed;'>" +
            "<tr>" +
            "<td style='width: 20%;'><p>Appuyez sur " + left_key_html + " pour :</br><span class='iat_color_black'>" + block_1_label_left.bold() + "</span></td>" +
            "<td></td>" +
            "<td style='width: 20%;'><p>Appuyez sur " + right_key_html + " pour :</br><span class='iat_color_black'>" + block_1_label_right.bold() + "</span></td>" +
            "</tr>" +
            "</table>" +
            "</br></br></br></br></br></br></br></br>" +
            "<p class='justify' style='padding: 0 40px 0 40px;'>" +
            "Mettez vos indexes ou majeurs sur les touches " + left_key_html + " et " +
            right_key_html + " de votre clavier. Des <span class='iat_color_black'>prénoms</span> appartenant aux catégories indiquées en haut de votre écran vont apparaître " +
            "au milieu de l'écran. Quand l'item appartient à une catégorie sur la gauche, appuyez sur la touche " + left_key_html + "; " +
            "lorsque l'item appartient à une catégorie sur la droite, appuyez sur la touche " + right_key_html + ".</br></br>" +
            "Les items appartiennent à une seule catégorie. Si vous faites une erreur, un " +
            "<span style='color: red'>X</span> rouge apparaîtra; corrigez l'erreur en pressant l'autre touche.</br></br>" +
            "La rapidité de vos réponses à cette tâche de classification est importante. " +
            "Allez <b>aussi vite que possible</b> tout en faisant aussi <b>peu d'erreurs</b> que possible. " +
            "Si vous allez trop lentement ou faites trop d'erreurs, cela produira un score ininterprétable. " +
            "Cette tâche durera environ 5 minutes.</p>" +
            "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour commencer</p>",
        on_load: function () {
            $('#jspsych-content').css({ "max-width": "100%" });
            $('#jspsych-content').css({ "margin": "0px" });
            $('#jspsych-content').css({ "width": "900px" });
        },
    };

    var IATinst_block_2 = {
        type: 'html-keyboard-response',
        choices: [32],
        stimulus: "<table class='iat_table' style='width: 100%; table-layout: fixed;'>" +
            "<tr>" +
            "<td style='width: 20%;'><p>Appuyez sur " + left_key_html + " pour :</br><span class='iat_color_green'>" + block_2_label_left.bold() + "</span></td>" +
            "<td></td>" +
            "<td style='width: 20%;'><p>Appuyez sur " + right_key_html + " pour :</br><span class='iat_color_green'>" + block_2_label_right.bold() + "</span></td>" +
            "</tr>" +
            "</table>" +
            "</br></br></br></br></br></br></br></br>" +
            "<p class='justify' style='padding: 0 40px 0 40px;'>" +
            "Regardez ci-dessus; les <b>catégories ont changé</b>. Les <span class='iat_color_green'>mots</span> à classer ont changé également. " +
            "La façon de procéder, par contre, est toujours la même.</br></br>" +
            "Quand l'item appartient à une catégorie sur la gauche, appuyez sur la touche " + left_key_html + "; " +
            "lorsque l'item appartient à une catégorie sur la droite, appuyez sur la touche " + right_key_html + ".</br></br>" +
            "Les items appartiennent à une seule catégorie. Si vous faites une erreur, un " +
            "<span style='color: red'>X</span> rouge apparaîtra; corrigez l'erreur en pressant l'autre touche.</br></br>" +
            "La rapidité de vos réponses à cette tâche de classification est importante. " +
            "Allez <b>aussi vite que possible</b> tout en faisant aussi peu d'erreurs que possible." +
            "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour commencer</p>",
    };

    var IATinst_block_3 = {
        type: 'html-keyboard-response',
        choices: [32],
        stimulus: "<table class='iat_table' style='width: 100%; table-layout: fixed;'>" +
            "<tr>" +
            "<td style='width: 20%;'><p>Appuyez sur " + left_key_html + " pour :</br><span class='iat_color_black'>" + block_3_label_left_top.bold() +
            "</span></br>ou</br><span class='iat_color_green'>" + block_3_label_left_bot.bold() + "</span></td>" +
            "<td></td>" +
            "<td style='width: 20%;'><p>Appuyez sur " + right_key_html + " pour :</br><span class='iat_color_black'>" + block_3_label_right_top.bold() +
            "</span></br>ou</br><span class='iat_color_green'>" + block_3_label_right_bot.bold() + "</span></td>" +
            "</tr>" +
            "</table>" +
            "</br></br></br></br></br></br></br></br>" +
            "<p class='justify' style='padding: 0 40px 0 40px;'>" +
            "Regardez ci-dessus; les quatre catégories que vous avez vues séparément apparaissent maintenant ensemble. " +
            "Rappelez-vous que chaque item appartient seulement à un groupe.</br></br>" +
            "Les labels et items <span class='iat_color_green'>verts</span> et <span class='iat_color_black'>noirs</span> " +
            "devraient vous aider à identifier la catégorie pertinente. " +
            "Utilisez les touches " + left_key_html + " et " + right_key_html + " pour catégoriser les items dans " +
            "les quatres groupes figurant à <b>gauche</b> ou à <b>droite</b>, " +
            "et corrigez les erreurs en pressant l'autre touche.</br></br>" +
            "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour commencer</p>",
    };

    var IATinst_block_4 = {
        type: 'html-keyboard-response',
        choices: [32],
        stimulus: "<table class='iat_table' style='width: 100%; table-layout: fixed;'>" +
            "<tr>" +
            "<td style='width: 20%;'><p>Appuyez sur " + left_key_html + " pour :</br><span class='iat_color_black'>" + block_4_label_left_top.bold() +
            "</span></br>ou</br><span class='iat_color_green'>" + block_4_label_left_bot.bold() + "</span></td>" +
            "<td></td>" +
            "<td style='width: 20%;'><p>Appuyez sur " + right_key_html + " pour :</br><span class='iat_color_black'>" + block_4_label_right_top.bold() +
            "</span></br>ou</br><span class='iat_color_green'>" + block_4_label_right_bot.bold() + "</span></td>" +
            "</tr>" +
            "</table>" +
            "</br></br></br></br></br></br></br></br>" +
            "<p class='justify' style='padding: 0 40px 0 40px;'>" +
            "Classez à nouveau les quatres mêmes catégories. Rappelez-vous d'aller aussi vite que possible tout en faisant " +
            "aussi peu d'erreurs que possible.</br></br>" +
            "Les labels et items <span class='iat_color_green'>verts</span> et <span class='iat_color_black'>noirs</span> " +
            "devraient vous aider à identifier la catégorie pertinente. " +
            "Utilisez les touches " + left_key_html + " et " + right_key_html + " pour catégoriser les items dans " +
            "les quatres groupes figurant à <b>gauche</b> ou à <b>droite</b>, " +
            "et corrigez les erreurs en pressant l'autre touche.</br></br>" +
            "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour commencer</p>",
    };

    var IATinst_block_5 = {
        type: 'html-keyboard-response',
        choices: [32],
        stimulus: "<table class='iat_table' style='width: 100%; table-layout: fixed;'>" +
            "<tr>" +
            "<td style='width: 20%;'><p>Appuyez sur " + left_key_html + " pour :</br><span class='iat_color_black'>" + block_5_label_left.bold() + "</span></td>" +
            "<td></td>" +
            "<td style='width: 20%;'><p>Appuyez sur " + right_key_html + " pour :</br><span class='iat_color_black'>" + block_5_label_right.bold() + "</span></td>" +
            "</tr>" +
            "</table>" +
            "</br></br></br></br></br></br></br></br>" +
            "<p class='justify' style='padding: 0 40px 0 40px;'>" +
            "Remarquez ci-dessus: il y a seulement <b>deux catéories</b> et <b>leurs positions ont changé</b>. " +
            "Le concept qui précédemment était sur la gauche est maintenant sur la droite, et le concept qui " +
            "qui était sur la droite est maintenant sur la gauche. Exercez cette nouvelle configuration.</br></br>" +
            "Utilisez les touches " + left_key_html + " et " + right_key_html + " pour catégoriser les items dans " +
            "les quatres groupes figurant à <b>gauche</b> ou à <b>droite</b>, " +
            "et corrigez les erreurs en pressant l'autre touche.</br></br>" +
            "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour commencer</p>",
    };

    var IATinst_block_6 = {
        type: 'html-keyboard-response',
        choices: [32],
        stimulus: "<table class='iat_table' style='width: 100%; table-layout: fixed;'>" +
            "<tr>" +
            "<td style='width: 20%;'><p>Appuyez sur " + left_key_html + " pour :</br><span class='iat_color_black'>" + block_6_label_left_top.bold() +
            "</span></br>ou</br><span class='iat_color_green'>" + block_6_label_left_bot.bold() + "</span></td>" +
            "<td></td>" +
            "<td style='width: 20%;'><p>Appuyez sur " + right_key_html + " pour :</br><span class='iat_color_black'>" + block_6_label_right_top.bold() +
            "</span></br>ou</br><span class='iat_color_green'>" + block_6_label_right_bot.bold() + "</span></td>" +
            "</tr>" +
            "</table>" +
            "</br></br></br></br></br></br></br></br>" +
            "<p class='justify' style='padding: 0 40px 0 40px;'>" +
            "Regardez ci-dessus; les quatre catégories apparaissent maintenant ensemble dans une <b>nouvelle configuration</b>. " +
            "Rappelez-vous que chaque item appartient seulement à un groupe.</br></br>" +
            "Les labels et items <span class='iat_color_green'>verts</span> et <span class='iat_color_black'>noirs</span> " +
            "devraient vous aider à identifier la catégorie pertinente. " +
            "Utilisez les touches " + left_key_html + " et " + right_key_html + " pour catégoriser les items dans " +
            "les quatres groupes figurant à <b>gauche</b> ou à <b>droite</b>, " +
            "et corrigez les erreurs en pressant l'autre touche.</br></br>" +
            "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour commencer</p>",
    };

    var IATinst_block_7 = {
        type: 'html-keyboard-response',
        choices: [32],
        stimulus: "<table class='iat_table' style='width: 100%; table-layout: fixed;'>" +
            "<tr>" +
            "<td style='width: 20%;'><p>Appuyez sur " + left_key_html + " pour :</br><span class='iat_color_black'>" + block_7_label_left_top.bold() +
            "</span></br>ou</br><span class='iat_color_green'>" + block_7_label_left_bot.bold() + "</span></td>" +
            "<td></td>" +
            "<td style='width: 20%;'><p>Appuyez sur " + right_key_html + " pour :</br><span class='iat_color_black'>" + block_7_label_right_top.bold() +
            "</span></br>ou</br><span class='iat_color_green'>" + block_7_label_right_bot.bold() + "</span></td>" +
            "</tr>" +
            "</table>" +
            "</br></br></br></br></br></br></br></br>" +
            "<p class='justify' style='padding: 0 40px 0 40px;'>" +
            "Classez à nouveau les quatres mêmes catégories. Rappelez-vous d'aller aussi vite que possible tout en faisant " +
            "aussi peu d'erreurs que possible.</br></br>" +
            "Les labels et items <span class='iat_color_green'>verts</span> et <span class='iat_color_black'>noirs</span> " +
            "devraient vous aider à identifier la catégorie pertinente. " +
            "Utilisez les touches " + left_key_html + " et " + right_key_html + " pour catégoriser les items dans " +
            "les quatres groupes figurant à <b>gauche</b> ou à <b>droite</b>, " +
            "et corrigez les erreurs en pressant l'autre touche.</br></br>" +
            "<p></br>appuyez sur <span class='light-keys'><kbd>espace</kbd></span> pour commencer</p>",
    };

    // IAT functions
    var shuffleIATstims = function (stims) {
        // Alterenate categories blackWhite vs. goodBad
        var n = stims.length / 2;
        var chunkedStims = _.chunk(stims, n);
        var stims1 = jsPsych.randomization.shuffleNoRepeats(chunkedStims[0]);
        var stims2 = jsPsych.randomization.shuffleNoRepeats(chunkedStims[1]);

        var stims12 = stims1.map(function (e, i) { // merge two arrays so that the values alternate
            return [e, stims2[i]];
        });
        var stims21 = stims2.map(function (e, i) {
            return [e, stims1[i]];
        });

        var t = _.sample([stims12, stims21]);
        t = _.flattenDeep(t);

        return t;
    };

    var genIATblock = function (stims) {
        var trial_block = {
            timeline_variables: stims,
            timeline: [{
                type: 'iat-html',
                stimulus: function () {
                    if (jsPsych.timelineVariable('category', true) == label_good_bad[0] | jsPsych.timelineVariable('category', true) == label_good_bad[1]) {
                        return "<span class='iat_color_green'>" + jsPsych.timelineVariable('stimulus', true) + "</span>";
                    } else {
                        return "<span class='iat_color_black'>" + jsPsych.timelineVariable('stimulus', true) + "</span>";
                    };
                },
                html_when_wrong: '<span style="color: red; font-size: 50px">X</span>',
                stim_key_association: jsPsych.timelineVariable('correct_key'),
                bottom_instructions: "<p>Si vous appuyez sur la mauvaise touche, un <span style='color: red'>X</span> rouge apparaîtra. Appuyez sur l'autre touche pour continuer</p>",
                force_correct_key_press: true,
                display_feedback: true,
                left_category_key: left_key,
                right_category_key: right_key,
                left_category_label: function () {
                    var label = jsPsych.timelineVariable('labels_left', true);
                    if (label.length == 1) {
                        if (label[0] == label_good_bad[0] | label[0] == label_good_bad[1]) {
                            label[0] = "<span class='iat_color_green'>" + label[0] + "</span>";
                        } else {
                            label[0] = "<span class='iat_color_black'>" + label[0] + "</span>";
                        };
                    } else {
                        if (label[0] == label_good_bad[0] | label[0] == label_good_bad[1]) {
                            label[0] = "<span class='iat_color_green'>" + label[0] + "</span>";
                        } else {
                            label[0] = "<span class='iat_color_black'>" + label[0] + "</span>";
                        };
                        if (label[1] == label_good_bad[0] | label[1] == label_good_bad[1]) {
                            label[1] = "<span class='iat_color_green'>" + label[1] + "</span>";
                        } else {
                            label[1] = "<span class='iat_color_black'>" + label[1] + "</span>";
                        };
                    };
                    return label;
                },
                right_category_label: function () {
                    var label = jsPsych.timelineVariable('labels_right', true);
                    if (label.length == 1) {
                        if (label[0] == label_good_bad[0] | label[0] == label_good_bad[1]) {
                            label[0] = "<span class='iat_color_green'>" + label[0] + "</span>";
                        } else {
                            label[0] = "<span class='iat_color_black'>" + label[0] + "</span>";
                        };
                    } else {
                        if (label[0] == label_good_bad[0] | label[0] == label_good_bad[1]) {
                            label[0] = "<span class='iat_color_green'>" + label[0] + "</span>";
                        } else {
                            label[0] = "<span class='iat_color_black'>" + label[0] + "</span>";
                        };
                        if (label[1] == label_good_bad[0] | label[1] == label_good_bad[1]) {
                            label[1] = "<span class='iat_color_green'>" + label[1] + "</span>";
                        } else {
                            label[1] = "<span class='iat_color_black'>" + label[1] + "</span>";
                        };
                    };
                    return label;
                },
                response_ends_trial: true
            }],
            data: {
                label_left_top: jsPsych.timelineVariable('label_left_top'),
                label_left_bot: jsPsych.timelineVariable('label_left_bot'),
                label_right_top: jsPsych.timelineVariable('label_right_top'),
                label_right_bot: jsPsych.timelineVariable('label_right_bot'),
                blockNum: jsPsych.timelineVariable('blockNum'),
                type: jsPsych.timelineVariable('type'),
                category: jsPsych.timelineVariable('category'),
                categories: jsPsych.timelineVariable('categories'),
                stimulus: jsPsych.timelineVariable('stimulus'),
                task: "IAT",
            },
            on_load: function () {
                $('#jspsych-content').css({ "max-width": "100%" });
                $('#jspsych-content').css({ "margin": "0px" });
                $('#jspsych-content').css({ "width": "900px" });
            },
            on_finish: function (data) {
                console.log(jsPsych.data.getLastTrialData().json());
            },
        }
        return trial_block;
    };

    // block stims
    var block_1 = _.cloneDeep(IATstims_blackWhite);
    block_1 = _.shuffle(block_1);
    block_1.map(function (x) {
        x.label_left_top = block_1_label_left;
        x.label_left_bot = undefined;
        x.label_right_top = block_1_label_right;
        x.label_right_bot = undefined;
        x.labels_left = [block_1_label_left];
        x.labels_right = [block_1_label_right];
        x.correct_key = x.category == x.labels_left[0] ? 'left' : 'right';
        x.type = 'practice';
        x.blockNum = 1;
    });

    var block_2 = _.cloneDeep(IATstims_goodBad);
    block_2 = _.shuffle(block_2);
    block_2.map(function (x) {
        x.label_left_top = block_2_label_left;
        x.label_left_bot = undefined;
        x.label_right_top = block_2_label_right;
        x.label_right_bot = undefined;
        x.labels_left = [block_2_label_left];
        x.labels_right = [block_2_label_right];
        x.correct_key = x.category == x.labels_left[0] ? 'left' : 'right';
        x.type = 'practice';
        x.blockNum = 2;
    });

    var block_3 = _.flattenDeep([_.cloneDeep(IATstims_blackWhite), _.cloneDeep(IATstims_goodBad)]);
    block_3 = shuffleIATstims(block_3);
    block_3.map(function (x) {
        x.label_left_top = block_3_label_left_top;
        x.label_left_bot = block_3_label_left_bot;
        x.label_right_top = block_3_label_right_top;
        x.label_right_bot = block_3_label_right_bot;
        x.labels_left = [block_3_label_left_top, block_3_label_left_bot];
        x.labels_right = [block_3_label_right_top, block_3_label_right_bot];
        x.correct_key = (x.category == x.labels_left[0] | x.category == x.labels_left[1]) ? 'left' : 'right';
        x.type = 'practice';
        x.blockNum = 3;
    });

    var block_4 = _.flattenDeep([_.cloneDeep(IATstims_blackWhite), _.cloneDeep(IATstims_blackWhite), _.cloneDeep(IATstims_goodBad), _.cloneDeep(IATstims_goodBad)]);
    block_4 = shuffleIATstims(block_4);
    block_4.map(function (x) {
        x.label_left_top = block_4_label_left_top;
        x.label_left_bot = block_4_label_left_bot;
        x.label_right_top = block_4_label_right_top;
        x.label_right_bot = block_4_label_right_bot;
        x.labels_left = [block_4_label_left_top, block_4_label_left_bot];
        x.labels_right = [block_4_label_right_top, block_4_label_right_bot];
        x.correct_key = (x.category == x.labels_left[0] | x.category == x.labels_left[1]) ? 'left' : 'right';
        x.type = 'test';
        x.blockNum = 4;
    });

    var block_5 = _.cloneDeep(IATstims_blackWhite);
    block_5 = _.shuffle(block_5);
    block_5.map(function (x) {
        x.label_left_top = block_5_label_left;
        x.label_left_bot = undefined;
        x.label_right_top = block_5_label_right;
        x.label_right_bot = undefined;
        x.labels_left = [block_5_label_left];
        x.labels_right = [block_5_label_right];
        x.correct_key = x.category == x.labels_left[0] ? 'left' : 'right';
        x.type = 'practice';
        x.blockNum = 5;
    });

    var block_6 = _.flattenDeep([_.cloneDeep(IATstims_blackWhite), _.cloneDeep(IATstims_goodBad)]);
    block_6 = shuffleIATstims(block_6);
    block_6.map(function (x) {
        x.label_left_top = block_6_label_left_top;
        x.label_left_bot = block_6_label_left_bot;
        x.label_right_top = block_6_label_right_top;
        x.label_right_bot = block_6_label_right_bot;
        x.labels_left = [block_6_label_left_top, block_6_label_left_bot];
        x.labels_right = [block_6_label_right_top, block_6_label_right_bot];
        x.correct_key = (x.category == x.labels_left[0] | x.category == x.labels_left[1]) ? 'left' : 'right';
        x.type = 'practice';
        x.blockNum = 6;
    });

    var block_7 = _.flattenDeep([_.cloneDeep(IATstims_blackWhite), _.cloneDeep(IATstims_blackWhite), _.cloneDeep(IATstims_goodBad), _.cloneDeep(IATstims_goodBad)]);
    block_7 = shuffleIATstims(block_7);
    block_7.map(function (x) {
        x.label_left_top = block_7_label_left_top;
        x.label_left_bot = block_7_label_left_bot;
        x.label_right_top = block_7_label_right_top;
        x.label_right_bot = block_7_label_right_bot;
        x.labels_left = [block_7_label_left_top, block_7_label_left_bot];
        x.labels_right = [block_7_label_right_top, block_7_label_right_bot];
        x.correct_key = (x.category == x.labels_left[0] | x.category == x.labels_left[1]) ? 'left' : 'right';
        x.type = 'test';
        x.blockNum = 7;
    });

    // generate IAT blocks
    var IAT_block_1 = genIATblock(block_1);
    var IAT_block_2 = genIATblock(block_2);
    var IAT_block_3 = genIATblock(block_3);
    var IAT_block_4 = genIATblock(block_4);
    var IAT_block_5 = genIATblock(block_5);
    var IAT_block_6 = genIATblock(block_6);
    var IAT_block_7 = genIATblock(block_7);


    // DEMO --------------------------------------------------------------------------------------------------------------
    var age = {
        timeline: [{
            type: 'survey-text',
            questions: [{ prompt: "Veuillez indiquer votre âge :", rows: 1, columns: 10 }],
            button_label: "Continuer",
        }],
        loop_function: function (data) {
            var age = data.values()[0].responses;
            var age = JSON.parse(age).Q0;
            if (age == "") {
                alert("Veuillez indiquer votre âge !");
                return true;
            }
        },
        on_load: function () {
            $('#jspsych-content').css({ "margin": "100px" });
        },
        on_finish: function (data) {
            jsPsych.data.addProperties({
                age: JSON.parse(data.responses)["Q0"],
            });
        },
    };

    var gender = {
        type: 'survey-multi-choice',
        questions: [{ prompt: "Veuillez indiquer votre genre :", options: ['homme', 'femme', 'autre'], required: true }],
        button_label: "Continuer",
        on_finish: function (data) {
            jsPsych.data.addProperties({
                gender: JSON.parse(data.responses)["Q0"],
            });
        },
    };

    var origin = {
        type: 'survey-multi-choice',
        questions: [{ prompt: "De quelle origine vous estimez-vous ?", options: ["D'origine belge", "D'origine française", "D'origine maghrébine", "D'une autre origine"], required: true }],
        button_label: "Continuer",
        on_finish: function (data) {
            jsPsych.data.addProperties({
                origin: JSON.parse(data.responses)["Q0"],
            });
        },
    };

    /*  ~~~~~~~~~~~~~~~~ TIMELINES ~~~~~~~~~~~~~~~~ */
    timeline.push(activeFullscreen);
    timeline.push(RCinst);
    timeline.push(RC);
    timeline.push(IATinst_1);
    timeline.push(IATinst_2);
    timeline.push(IATinst_block_1);
    timeline.push(IAT_block_1);
    timeline.push(IATinst_block_2);
    timeline.push(IAT_block_2);
    timeline.push(IATinst_block_3);
    timeline.push(IAT_block_3);
    timeline.push(IATinst_block_4);
    timeline.push(IAT_block_4);
    timeline.push(IATinst_block_5);
    timeline.push(IAT_block_5);
    timeline.push(IATinst_block_6);
    timeline.push(IAT_block_6);
    timeline.push(IATinst_block_7);
    timeline.push(IAT_block_7);
    timeline.push(age);
    timeline.push(gender);
    timeline.push(origin);

    /*  ~~~~~~~~~~~~~~~~ INIT ~~~~~~~~~~~~~~~~ */
    jsPsych.init({
        timeline: _.flattenDeep(timeline),
        preload_images: preloadimages,
        max_load_time: 1000 * 900,
        // exclusions: {
        //     min_width: 1100,
        //     min_height: 700,
        // },
        on_interaction_data_update: function (data) {
            // console.log(JSON.stringify(data))
        },
        on_finish: function (data) {
            $("#jspsych-content").html("<img src='https://i.gifer.com/4V0b.gif'>");

            /* Initialize Firebase */
            var config = {
                apiKey: "AIzaSyD4r9uWI4icto61fm2tC9neKdEiOUWzMJ8",
                databaseURL: "https://biatw-68fe6.firebaseio.com/"
            };

            firebase.initializeApp(config);
            var database = firebase.database();

            // if no id provided, generate a new id
            if (id == null) { id = jsPsych.randomization.randomID(15) };

            /* Qualtrics url parameters */
            // qlink += "?id=" + id;
            // qlink += "&cond=" + RCcondition;
            // qlink += "&windWidth=" + window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
            // qlink += "&windHeight=" + window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
            // qlink += "&screenWidth=" + screen.width || 0;
            // qlink += "&screenHeight=" + screen.height || 0;
            // qlink += "&userAgent=" + navigator.userAgent;
            // qlink += "&totalTime=" + jsPsych.totalTime();

            /* jsPsych: add data to every trial */
            jsPsych.data.addProperties({
                id: id
            });

            var dataRC = data.filter({ task: 'RC' }).csv();
            var dataIAT = data.filter({ task: 'IAT' }).csv();
            // jsPsych.data.displayData();

            /* Send data to Firebase and redirect to Qualtrics */
            database
                .ref("RCiat/" + "RC/" + id + "/")
                .update({ dataRC })
                .then(function () {
                    console.log("Data RC sent!");
                    database
                        .ref("RCiat/" + "IAT/" + id + "/")
                        .update({ dataIAT })
                        .then(function () {
                            console.log("Data IAT sent!");
                            window.location.href = qlink;
                            // jsPsych.data.displayData();
                        });;
                });;
        }
    });
</script>

</html>