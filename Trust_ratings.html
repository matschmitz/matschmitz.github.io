<!-- 
DESCRIPTION ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

-->
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>exp</title>
  <script src="jspsych-6.0.3/jspsych.js"></script>
  <script src="jspsych-6.0.3/plugins/jspsych-fullscreen.js"></script>
  <script src="jspsych-6.0.3/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.0.3/plugins/jspsych-image-keyboard-response.js"></script>
  <script src="jspsych-6.0.3/plugins/jspsych-html-button-response.js"></script>
  <script src="jspsych-6.0.3/plugins/jspsych-survey-text.js"></script>
  <script src="jspsych-6.0.3/plugins/jspsych-survey-likert.js"></script>
  <script src="jspsych-6.0.3/plugins/jspsych-survey-multi-choice.js"></script>
  <script src="js/jspsych-html-slider-response_required.js"></script>
  <script src="js/jquery.min.js"></script>
  <script src="js/lodash.min.js"></script>
  <script src="js/firebase.js"></script>
  <link href="jspsych-6.0.3/css/jspsych.css" rel="stylesheet" type="text/css">
  <style>
    body {
      cursor: default;
    }

    #jspsych-html-slider-response-next {
      margin: 0px;
    }

    .imgJudge {
      width: 300px;
      margin: 0px;
      padding: 0px;
    }

    .jspsych-content-wrapper {
      width: 800px;
      height: 600px;
    }
  </style>
</head>

<body></body>
<script>
  /* Parameters */
  var n = 10; // number of CIs randomly sampled for each cell
  var githubCIs = 'https://raw.githubusercontent.com/marinerougier/cis_gene_Expe3/master/'; // github CIs path

  /* Initial variables */
  var timeline = [];
  var preloadimages = [];
  var prolificID = jsPsych.data.getURLVariable("prolificID"); // Need to add ?prolificID={{%PROLIFIC_PID%}} at the end of the prolific survey link!

  // EXPERIMENT --------------------------------------------------------------------------------------------------------

  var scaleTrustworthiness = ["1</br>Not-at-all trustworthy", "2", "3", "4", "5", "6", "7", "8", "9</br>Extremely trustworthy"];

  var face_name_procedure = {
    timeline: [
      {
        trial_duration: 1000,
        post_trial_gap: 100,
        type: 'image-keyboard-response',
        stimulus: jsPsych.timelineVariable('face'),
        choices: jsPsych.NO_KEYS,
      },
      {
        type: 'survey-likert',
        questions: [
          { prompt: "How trustworthy is this person?", labels: scaleTrustworthiness, required: true },
        ],
        on_load: function () {
          $(".jspsych-content").css("max-width", "100%");
          $(".jspsych-survey-likert-statement").css("margin", "0px");
          $(".jspsych-survey-likert-statement").css("padding", "0px");
          $(".jspsych-survey-likert-opts").css("padding", "0 0 10px");
          $("#jspsych-survey-likert-next").css("margin-top", "10px");
          $("#jspsych-survey-likert-form").css("width", "800px");
          $("li").css("width", "9%");
          //   $("li:first-of-type").css("width", "110px");
          //   $("li:last-of-type").css("width", "110px");
        },
        on_finish: function (data) {
          // add & clean data
          data.rating = JSON.parse(data.responses)["Q0"] + 1;
          data.face = jsPsych.timelineVariable('face', true);

          // log responses on the console for debug
          console.log(jsPsych.data.getLastTrialData().json());

          // reset default css
          $(".jspsych-survey-likert-statement").css("padding", "30px");
        },
      },
    ],
    timeline_variables: [
      { face: 'arts_01.bmp' },
      { face: 'arts_02.bmp' },
      { face: 'arts_01.bmp' },
      { face: 'arts_02.bmp' }
    ],
    randomize_order: true
  }


  /* DEBRIEF */
  var debrief = [];
  debrief += "<h1>Fin de l'expérience</h1>";
  debrief += "<p class='justify'>Merci pour votre participation ! Cette étude avait pour but d'étudier la perception générale ";
  debrief += "qu'ont les individus de visages inconnus et ambigus.</br></br> "
  debrief += "<b>Veuillez copier le code suivant sur Foule Factory pour valider votre participation :</b></p> ";
  debrief += "<h1>JYP63M</h1>";
  //debrief += "<a href='https://www.google.com/' target='_blank'>cliquer ici pour valider votre expérience</a>";

  // TIMELINE ----------------------------------------------------------------------------------------------------------
  timeline.push(face_name_procedure);

  timeline = _.flattenDeep(timeline); // do not remove this!

  // INITIALISE EXP ----------------------------------------------------------------------------------------------------
  jsPsych.init({
    timeline: timeline,
    preload_images: preloadimages,
    max_load_time: 500 * 1000,
    exclusions: {
      min_width: 800,
      min_height: 600,
    },
    on_finish: function (data) {
      $("#jspsych-content").html("<img src='https://i.gifer.com/4V0b.gif'>");

      /* Initialize Firebase */
      var config = {
        apiKey: "AIzaSyBwDr8n-RNCbBOk1lKIxw7AFgslXGcnQzM",
        databaseURL: "https://marineexpe.firebaseio.com/"
      };

      firebase.initializeApp(config);
      var database = firebase.database();
      id = jsPsych.randomization.randomID(15); // short ID

      /* jsPsych: add data to every trial */
      jsPsych.data.addProperties({
        prolificID: prolificID,
        id: id,
        //traitsOrder: traitsOrder,
        totalTime: jsPsych.totalTime()
      });

      var subdata = data.filter({ trial_type: 'survey-likert' }).csv();
      jsPsych.data.displayData();

      /* Send data to Firebase and redirect to Qualtrics */
      database.ref("judgeMarine3/" + id + "/").update({ subdata }).then(function () {
        console.log("data sent!");
        $("#jspsych-content").html(debrief);
        //window.location.href = qlink; // redirect to qualtrics
      });
    }
  });
</script>

</html>