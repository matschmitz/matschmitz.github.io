<!--
TO DO:
- Update Qualtrics link
- Update Qualtrics debriefing
- remove display data
- Adjust parameters
-->

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>exp</title>
    <script src="jspsych-6.0.3/jspsych.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.0.3/plugins/jspsych-survey-text.js"></script>
    <script src="js/jspsych-categorize-html-mat.js"></script>
    <script src="js/jquery.min.js"></script> <!-- https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js -->
    <script src="js/lodash.min.js"></script> <!-- https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js -->
    <script src="js/firebase.js"></script>   <!-- https://www.gstatic.com/firebasejs/5.0.4/firebase.js -->
    <link href="jspsych-6.0.3/css/jspsych.css" rel="stylesheet" type="text/css">
    <script>
    /* Parameters */
    var itiSta    = 400;    // 400; inter-trial-interval for statements
    var delaySta  = 5500;   // 5500; how long is each statement displayed
    var memoDelay = 45000;  // 45000; timer to memorize names
    var biatRep   = 2;      // 2; number of BIAT repetitions
    var qlink     = "https://uclpsychology.co1.qualtrics.com/jfe/form/SV_578XUB39jqAbg6p";
    
    /* Initial variables */
    var timeline = [];
    var HC = [];
    var LC = [];
    var id = jsPsych.data.getURLVariable("id");
    var cond = jsPsych.data.getURLVariable("cond");
    
    function genBiatBlockStims(fclCat,   itemsFclCat,  
                               fclAtt,   itemsFclAtt,
                               unFclCat, itemsUnFclCat,
                               unFclAtt, itemsUnFclAtt) {
        // fclCat, fclAtt, unFclCat, unFclAtt: string
        // itemsFclCat, itemsFclAtt, itemsUnFclCat, itemsUnFclAtt: array
        var stims = jsPsych.randomization.factorial({
            target:    _.flattenDeep([itemsFclCat, itemsFclAtt, itemsUnFclCat, itemsUnFclAtt]),
            attribute: [fclAtt],
            category:  [fclCat],
        });
        
        // add targetClass and correctkey
        for (var i = 0; i < stims.length; i++) {
            if($.inArray(stims[i].target, itemsFclCat)   != -1) {stims[i].targetClass = fclCat};
            if($.inArray(stims[i].target, itemsFclAtt)   != -1) {stims[i].targetClass = fclAtt};
            if($.inArray(stims[i].target, itemsUnFclCat) != -1) {stims[i].targetClass = unFclCat};
            if($.inArray(stims[i].target, itemsUnFclAtt) != -1) {stims[i].targetClass = unFclAtt};
            
            var itemsBelongsToFclAtt = stims[i].targetClass == stims[i].attribute; // check if target is in focal attribute
            var itemsBelongsToFclcat = stims[i].targetClass == stims[i].category;  // check if target is in focal category
            if(itemsBelongsToFclAtt || itemsBelongsToFclcat) {stims[i].correctKey = 's'} else {stims[i].correctKey = 'l'};
        };
        return stims;
    };
    
    function genBiatBlock(fclCat,   itemsFclCat,  
                          fclAtt,   itemsFclAtt,
                          unFclCat, itemsUnFclCat,
                          unFclAtt, itemsUnFclAtt,
                          rep = 1) {
        
        var stims = genBiatBlockStims(fclCat,   itemsFclCat,  
                                      fclAtt,   itemsFclAtt,
                                      unFclCat, itemsUnFclCat,
                                      unFclAtt, itemsUnFclAtt);
        var biatInst = {
            type: "html-keyboard-response",
            choices: [32],
            stimulus: function(){
                var html = "";
                html += "<p><span class='emphasize'>"+fclCat +"</span>";
                html += "</br><span class='italic'>"+itemsFclCat[0]+" &nbsp;"+itemsFclCat[1]+" &nbsp;"+itemsFclCat[2]+" &nbsp;"+itemsFclCat[3]+"</span></p>";
                html += "<p><span class='emphasize'>"+fclAtt+"</span>";
                html += "</br><span class='italic'>"+itemsFclAtt[0]+" &nbsp;"+itemsFclAtt[1]+" &nbsp;"+itemsFclAtt[2]+" &nbsp;"+itemsFclAtt[3]+"</span></p>";
                html += "</br><p>Two <span class='emphasize'>categories</span>, and their <span class='italic'>items</span>, are displayed above.</br>";
                html += "Keep the two cateogies in your mind as you do the task.</p>";
                html += "<p>Press <span class='light-keys'><kbd>S</kbd></span> when an item matches EITHER category.";
                html += "</br>Press <span class='light-keys'><kbd>L</kbd></span> for anything else</p>";
                html += "<p>If you make an ERROR you will see a red <span style='color: red; font-weight: bold'>X</span>.</br>";
                html += "When this happens, make the CORRECT response to proceed.</br>";
                html += "Go FAST. A few errors are OK.</p>";
                html += "<p>press <span class='light-keys'><kbd>spacebar</kbd></span> to continue</p>";
                return html;
            },
        };
        
        var biatBlock = {
            timeline_variables: stims,
            repetitions: rep,
            randomize_order: true,
            timeline: [
                {
                    type: 'categorize-html',
                    stimulus: function(){
                        var html = "";
                        html += "<p><span class='emphasize'>"+jsPsych.timelineVariable('category', true) +"</span></p>";
                        html += "<p>or</p>";
                        html += "<p><span class='emphasize'>"+jsPsych.timelineVariable('attribute', true)+"</span></p>";
                        html += "<p class='italic'></br></br></br></br>"+jsPsych.timelineVariable('target', true);
                        html += "</br></br></br></br></br></br></br></p>";
                        return html;
                    },
                    key_answer: function(){return jsPsych.pluginAPI.convertKeyCharacterToKeyCode(jsPsych.timelineVariable('correctKey', true))},
                    choices: ['s', 'l'],
                    text_answer: '',
                    correct_text: "<p>&nbsp</p>",
                    correct_text_duration: 0,
                    incorrect_text: "<p><span style='color: red; font-weight: bold'>X</span> press the correct key to continue</p>",
                    prompt: function(){ return "<p>&nbsp</p>"; },
                    trial_duration: 10000,
                    timeout_message: "<p style='color: red;'>please respond faster.</p>",
                    show_feedback_on_timeout: false,
                    force_correct_button_press: true,
                    feedback_duration: 600,
                    data: {
                        attribute:   jsPsych.timelineVariable('attribute'),
                        category:    jsPsych.timelineVariable('category'),
                        target:      jsPsych.timelineVariable('target'),
                        correctKey:  jsPsych.timelineVariable('correctKey'),
                        targetClass: jsPsych.timelineVariable('targetClass'),
                        task:        'biat'
                    },
                }
            ]
        };
        
        return [biatInst, biatBlock];
    };

    /* Consent & Fullscreen mode */
    timeline.push({
        message: function() {
            html = "";
            html += "<h1>Informed Consent</h1>";
            html += "<p class='justify'>In this study about perception and memory you will be asked to memorize some information, ";
            html += "read some statements, write some text, complete a classification task and fill a survey. ";
            html += "This should take you approximately <strong>18 minutes</strong>. During this period, ";
            html += "it is important that you remain fully <strong>concentrated</strong>.</p>";
            html += "<p class='justify'>Your participation is voluntary, does not imply any risks, your answers will be ";
            html += "anonymous, and you are free to withdraw from the study at any moment. After full completion, ";
            html += "you will receive a <strong>monetary compensation</strong> as stated in the Prolific ";
            html += "description of this experiment.</p>";
            html += "<p class='justify'>This study is administrated by Mathias Schmitz, reasearcher at the UCLouvain (Belgium). ";
            html += "If you have any question or comment please contact me at <strong>mathias.schmitz@uclouvain.be</strong></p>";
            return html;
        },
        button_label: "I agree to take part in this study",
        type: 'fullscreen',
        fullscreen_mode: true,
        delay_after: 500,
        on_start: function() {$('body').css('cursor', 'default')},
        on_finish: function() {$('body').css('cursor', 'none')},
    });
    
    /*  ~~~~~~ Impression formation  ~~~~~~ */
    /* Generate statements */
    var CP = ['CP1', 'CP2', 'CP3', 'CP4', 'CP5', 'CP6', 'CP7', 'CP8']; // C+
    var CN = ['CN1', 'CN2', 'CN3', 'CN4', 'CN5', 'CN6', 'CN7', 'CN8']; // C-
    var WP = ['WP1', 'WP2', 'WP3', 'WP4', 'WP5', 'WP6', 'WP7', 'WP8']; // W+
    var WN = ['WN1', 'WN2', 'WN3', 'WN4', 'WN5', 'WN6', 'WN7', 'WN8']; // w-

    // HC: 6C+, 2C-, 2W+, 2W-
    HC = HC.concat(_.sampleSize(CP, 6), _.sampleSize(CN, 2), _.sampleSize(WP, 2), _.sampleSize(WN, 2));
    
    // LC: 2C+, 6C-, 2W+, 2W-
    var CPleft = _.difference(CP, HC);
    var CNleft = _.difference(CN, HC);
    var WPleft = _.difference(WP, HC);
    var WNleft = _.difference(WN, HC);
    LC = LC.concat(_.sampleSize(CPleft, 2), _.sampleSize(CNleft, 6), _.sampleSize(WPleft, 2), _.sampleSize(WNleft, 2));
    
    HC = _.shuffle(HC);
    LC = _.shuffle(LC);
    
    // Assign group identity (B vs. G)
    var hghGrp = _.sample(['B', 'G'])
    var lowGrp = _.difference(['B', 'G'], [hghGrp])[0];
    
    HC = HC.map(function(e) {return e + hghGrp});
    LC = LC.map(function(e) {return e + lowGrp});
    
    var hghFst = _.sample([true, false]);
    if(hghFst) { var staOrd = HC.concat(LC) } else { var staOrd = LC.concat(HC) }
    var staRdm = _.shuffle(staOrd);
    
    var CP = [
        "X won the yearly award for the employee who contributes most to the company’s profit.",
        "X practiced the violin piece 20 times a day and after a month felt that he/she had it right.",
        "X wrote a small computer program that solved a tough calculus integration problem.",
        "X speaks fluently three different languages.",
        "X presented his/her research at a chemistry congress.",
        "X published a short story in a literary magazine while still in college.",
        "X worked hard on the extra-credit assignment in linear algebra.",
        "X is very careful when it comes to savings so that buying that first house will be possible."
    ];
    var CN = [
        "X went hiking in the mountains and had to be rescued because he/she wasn’t paying attention to where he/she was going.",
        "X was fired from his/her job because he/she rarely got things done on time.",
        "X’s bicycle was stolen several times because he/she forgets to set the lock.",
        "X often gets lost when driving in the city, even though he/she has been living there for several years.",
        "X’s electricity was turned off because he/she did not paid the bill on time.",
        "X had trouble finding work because he/she was always late for job interviews.",
        "X took almost an hour to find his/her car after parking it in a shopping mall.",
        "X did not pass his/her driving test for the third time and ended up abandoning it."
    ];
    var WP = [
        "X spent hours with a friend whose dog died.",
        "X loves to be with other people.",
        "X helped a blind woman cross the street.",
        "X always greets friends with a big hug.",
        "X always smiles at strangers on the street just to make their day better.",
        "X loves to hold hands while walking.",
        "X enjoys having long conversations with friends.",
        "X gave up his/her seat on the crowded bus when an elderly woman got on."
    ];
    var WN = [
        "X couldn’t be bothered to give directions to a stranger.",
        "X decided that everyone at the party was pretty shallow and left early.",
        "X prefers to go to the movie alone rather than with a friend.",
        "X yelled at the driver who took the last parking space.",
        "X rarely talked to the other people in the house that a bunch of them shared.",
        "X did not want to congratulate the winner of the competition.",
        "X didn’t go to his/her grandmother’s funeral because he/she was too busy with work.",
        "X yelled at a little girl for coloring outside the lines."
    ];
    
    staStim = {
        CP1B: "<p id='blueSta'>"+CP[0]+"</p>", CP1G: "<p id='greenSta'>"+CP[0]+"</p>",
        CP2B: "<p id='blueSta'>"+CP[1]+"</p>", CP2G: "<p id='greenSta'>"+CP[1]+"</p>",
        CP3B: "<p id='blueSta'>"+CP[2]+"</p>", CP3G: "<p id='greenSta'>"+CP[2]+"</p>",
        CP4B: "<p id='blueSta'>"+CP[3]+"</p>", CP4G: "<p id='greenSta'>"+CP[3]+"</p>",
        CP5B: "<p id='blueSta'>"+CP[4]+"</p>", CP5G: "<p id='greenSta'>"+CP[4]+"</p>",
        CP6B: "<p id='blueSta'>"+CP[5]+"</p>", CP6G: "<p id='greenSta'>"+CP[5]+"</p>",
        CP7B: "<p id='blueSta'>"+CP[6]+"</p>", CP7G: "<p id='greenSta'>"+CP[6]+"</p>",
        CP8B: "<p id='blueSta'>"+CP[7]+"</p>", CP8G: "<p id='greenSta'>"+CP[7]+"</p>",
        
        CN1B: "<p id='blueSta'>"+CN[0]+"</p>", CN1G: "<p id='greenSta'>"+CN[0]+"</p>",
        CN2B: "<p id='blueSta'>"+CN[1]+"</p>", CN2G: "<p id='greenSta'>"+CN[1]+"</p>",
        CN3B: "<p id='blueSta'>"+CN[2]+"</p>", CN3G: "<p id='greenSta'>"+CN[2]+"</p>",
        CN4B: "<p id='blueSta'>"+CN[3]+"</p>", CN4G: "<p id='greenSta'>"+CN[3]+"</p>",
        CN5B: "<p id='blueSta'>"+CN[4]+"</p>", CN5G: "<p id='greenSta'>"+CN[4]+"</p>",
        CN6B: "<p id='blueSta'>"+CN[5]+"</p>", CN6G: "<p id='greenSta'>"+CN[5]+"</p>",
        CN7B: "<p id='blueSta'>"+CN[6]+"</p>", CN7G: "<p id='greenSta'>"+CN[6]+"</p>",
        CN8B: "<p id='blueSta'>"+CN[7]+"</p>", CN8G: "<p id='greenSta'>"+CN[7]+"</p>",
        
        WP1B: "<p id='blueSta'>"+WP[0]+"</p>", WP1G: "<p id='greenSta'>"+WP[0]+"</p>",
        WP2B: "<p id='blueSta'>"+WP[1]+"</p>", WP2G: "<p id='greenSta'>"+WP[1]+"</p>",
        WP3B: "<p id='blueSta'>"+WP[2]+"</p>", WP3G: "<p id='greenSta'>"+WP[2]+"</p>",
        WP4B: "<p id='blueSta'>"+WP[3]+"</p>", WP4G: "<p id='greenSta'>"+WP[3]+"</p>",
        WP5B: "<p id='blueSta'>"+WP[4]+"</p>", WP5G: "<p id='greenSta'>"+WP[4]+"</p>",
        WP6B: "<p id='blueSta'>"+WP[5]+"</p>", WP6G: "<p id='greenSta'>"+WP[5]+"</p>",
        WP7B: "<p id='blueSta'>"+WP[6]+"</p>", WP7G: "<p id='greenSta'>"+WP[6]+"</p>",
        WP8B: "<p id='blueSta'>"+WP[7]+"</p>", WP8G: "<p id='greenSta'>"+WP[7]+"</p>",
        
        WN1B: "<p id='blueSta'>"+WN[0]+"</p>", WN1G: "<p id='greenSta'>"+WN[0]+"</p>",
        WN2B: "<p id='blueSta'>"+WN[1]+"</p>", WN2G: "<p id='greenSta'>"+WN[1]+"</p>",
        WN3B: "<p id='blueSta'>"+WN[2]+"</p>", WN3G: "<p id='greenSta'>"+WN[2]+"</p>",
        WN4B: "<p id='blueSta'>"+WN[3]+"</p>", WN4G: "<p id='greenSta'>"+WN[3]+"</p>",
        WN5B: "<p id='blueSta'>"+WN[4]+"</p>", WN5G: "<p id='greenSta'>"+WN[4]+"</p>",
        WN6B: "<p id='blueSta'>"+WN[5]+"</p>", WN6G: "<p id='greenSta'>"+WN[5]+"</p>",
        WN7B: "<p id='blueSta'>"+WN[6]+"</p>", WN7G: "<p id='greenSta'>"+WN[6]+"</p>",
        WN8B: "<p id='blueSta'>"+WN[7]+"</p>", WN8G: "<p id='greenSta'>"+WN[7]+"</p>",
    }
    
    /* ~~~~~~ Ingroup-name memorization ~~~~~~ */
    var namesF = ['Sophia', 'Olivia', 'Emma', 'Isabella'];
    var namesM = ['Liam', 'Lucas', 'Matthew', 'Michael'];
    var itemsGF = _.sampleSize(namesF, 2);
    var itemsGM = _.sampleSize(namesM, 2);
    var itemsBF = _.difference(namesF, itemsGF)
    var itemsBM = _.difference(namesM, itemsGM)
    var itemsG = _.shuffle(_.flattenDeep([itemsGF, itemsGM]));
    var itemsB = _.shuffle(_.flattenDeep([itemsBF, itemsBM]));

    var inGrp = _.sample(['B', 'G']); // _.sample(['B', 'G', 'O']);  B: Blue group | G: Green group | O: Observer
    if(cond != null) {inGrp = cond}; // manually set condition for testing
    if(inGrp == hghGrp) {var status = "H"};
    if(inGrp == lowGrp) {var status = "L"};
    if(inGrp == 'O')    {var status = 'O'};
    var inGrpLabel = '';
    if(inGrp == 'G') {inGrpLabel = "<span id='green'>Green</span>"} else {inGrpLabel = "<span id='blue'>Blue</span>"};
    if(inGrp == 'G') {var inGrpNames = itemsG} else {var inGrpNames = itemsB};
    if(inGrp == 'O') {inGrpLabel = "some <span id='green'>Green</span> and <span id='blue'>Blue</span>"};
    
    /*instructions */
    timeline.push({
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function() {
            var html = "";
            html += "<h1>Memorization task</h1>";
            html += "<p class='justify'>This experiment involves two groups of persons that we have called, for the sake of simplicity, ";
            html += "the <span id='green'>Green</span> and the <span id='blue'>Blue</span> group.</p>";
            html += "<p class='justify'>Your first task will be to learn the names of "+inGrpLabel+" group-members. ";
            html += "This will be useful further on.</br>";
            html += "<p class='justify'>These names will be presented on the following page for <span class='emphasize'>45 seconds</span>.";
            html += "<p class='justify'>Please try to <span class='emphasize'>memorize</span> these names.</p>";
            html += "<p id='continue'>press <span class='light-keys'><kbd>spacebar</kbd></span> to continue</p>";
            return html;
        },
    });
    
    
    timeline.push({
        type: "html-keyboard-response",
        choices: jsPsych.NO_KEYS,
        trial_duration: memoDelay,
        post_trial_gap: 200,
        stimulus: function() {
            var html = "";
            if(inGrp == 'O') {
                html += "<p><span id='green'>Green</span></br>group-members:<p>";
                html += "<p>"+itemsGF[0]+"</br></br>";
                html += itemsGM[0]+"</br></br></br></br>";
                html += "<p><span id='blue'>Blue</span></br>group-members:<p>";
                html += "<p>"+itemsBF[0]+"</br></br>";
                html += itemsBM[0]+"</br></br>";
            } else {
                html += "<p>"+inGrpLabel+"</br>group-members:<p></br></br>";
                html += "<p>"+inGrpNames[0]+"</br></br>";
                html += inGrpNames[1]+"</br></br>";
                html += inGrpNames[2]+"</br></br>";
                html += inGrpNames[3]+"</p>";
            };
            return html
        },
    });
    
    /* ~~~~~~ Statements ~~~~~~ */
    /* Sta rdm instructions */
    timeline.push({
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function() {
            var html = "";
            html += "<h1>Impression formation task</h1>";
            html += "<p class='justify'>You will now be presented a series of ";
            html += "anonymized behaviors that have been performed by members of ";
            html += "the <span id='green'>Green</span> or <span id='blue'>Blue</span> group.</p>";
            html += "<p class='justify'>Each behavior will be presented with a colored <span class='emphasize'>background, ";
            html += "indicating the group membership</span> of the person who performed it.</p>";
            html += "<p class='justify'>Your task is to simply <span class='emphasize'>read</span> each behavior ";
            html += "and do your best to <span class='emphasize'>form an impression</span> about these two groups. ";
            html += "Note that this is not a memory task and that the task will be automatically paced.</p>";
            html += "<p class='justify'>Please remain concentrated.</p>";
            html += "<p>press <span class='light-keys'><kbd>spacebar</kbd></span> to continue</p>";
            return html;
        },
    });
    
    /* Statements shuffled */
    staRdm.map(function(sta) {
        timeline.push({
            type: 'html-keyboard-response',
            stimulus: function() {return staStim[sta]},
            choices: jsPsych.NO_KEYS,
            trial_duration: delaySta,
            post_trial_gap: itiSta,
        })
    });
    
    /* Sta ord instructions */
    timeline.push({
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function() {
            var html = "";
            html += "<h1>Impression formation task</h1>";
            html += "<p class='justify'>We will now present you a last time each behavior.</p>";
            html += "<p class='justify'>You will first see all the behaviors from one group and then from the other group.</p>";
            html += "<p class='justify'>Your task is the same: <span class='emphasize'>read</span> each behavior ";
            html += "and do your best to <span class='emphasize'>form an impression</span> about these two groups. ";
            html += "Note that this is not a memory task and that the task will be automatically paced.</p>";
            html += "<p>press <span class='light-keys'><kbd>spacebar</kbd></span> to continue</p>";
            return html;
        },
    });
    
    /* Statements ordered */
    staOrd.map(function(sta) {
        timeline.push({
            type: 'html-keyboard-response',
            stimulus: function() {return staStim[sta]},
            choices: jsPsych.NO_KEYS,
            trial_duration: delaySta - 500,
            post_trial_gap: itiSta - 100,  
        })
    });
    
    /* Group description */
    var hghFstDscrp = _.sample([true, false]);
    
    timeline.push({
        type: 'survey-text',
        preamble: 'Without thinking too much about it, please tell us your impressions about...',
        questions: function() {
            var G = "<span id='green'>Green</span>";
            var B = "<span id='blue'>Blue</span>";
            
            function sendMsg(groupName) {return 'the '+groupName+' group:' +"</br><span id='min2lines'>(minimum: 2 lines)</span>";}
            
            if (hghGrp == 'B') { var HGname = B; var LGname = G; } else { var HGname = G; var LGname = B; };
            
            if (hghFstDscrp) {
                return [{prompt: sendMsg(HGname), rows: 5, columns: 80}, {prompt: sendMsg(LGname), rows: 5, columns: 80}];
            } else {
                return [{prompt: sendMsg(LGname), rows: 5, columns: 80}, {prompt: sendMsg(HGname), rows: 5, columns: 80}];
            };
        },
        on_start: function() {$('body').css('cursor', 'default')},
        on_finish: function() {$('body').css('cursor', 'none')},
    });
    
    /* ~~~~~~ Ingroup-name association task ~~~~~~ */
    var namesStim = [
        {target: itemsB[0], group: 'B', correctKeyBG: 's', correctKeyGB: 'l', color: 'blue',  lightColor: '#66b3ff'},
        {target: itemsB[1], group: 'B', correctKeyBG: 's', correctKeyGB: 'l', color: 'blue',  lightColor: '#66b3ff'},
        {target: itemsB[2], group: 'B', correctKeyBG: 's', correctKeyGB: 'l', color: 'blue',  lightColor: '#66b3ff'},
        {target: itemsB[3], group: 'B', correctKeyBG: 's', correctKeyGB: 'l', color: 'blue',  lightColor: '#66b3ff'},
        {target: itemsG[0], group: 'G', correctKeyBG: 'l', correctKeyGB: 's', color: 'green', lightColor: '#8cd98c'},
        {target: itemsG[1], group: 'G', correctKeyBG: 'l', correctKeyGB: 's', color: 'green', lightColor: '#8cd98c'},
        {target: itemsG[2], group: 'G', correctKeyBG: 'l', correctKeyGB: 's', color: 'green', lightColor: '#8cd98c'},
        {target: itemsG[3], group: 'G', correctKeyBG: 'l', correctKeyGB: 's', color: 'green', lightColor: '#8cd98c'},
    ];
    
    /* Instruction block 1 */
    timeline.push({
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function() {
            var html = "";
            html += "<h1>Categorization task</h1>";
            html += "<p class='justify'>In this task you will learn to classify the names of ";
            html += "<span id='green'>Green</span> and <span id='blue'>Blue</span> group members into their respective group. To do so:</p>";
            html += "<p class='justify'>press <span class='light-keys'><kbd>S</kbd></span> if the target name belongs to the ";
            html += "<span id='blue'>Blue</span> group</br>";
            html += "press <span class='light-keys'><kbd>L</kbd></span> if the target name belongs to the ";
            html += "<span id='green'>Green</span> group</p>";
            html += "<p class='justify'>Note that in this first task, each name will be colored according to its group membership but ";
            html += "later tasks will not have the names colored, so it is important that you learn ";
            html += "which names go with which groups.</p>";
            html += "<p>press <span class='light-keys'><kbd>spacebar</kbd></span> to continue</p>";
            return html
        },
    });
    
    var classNamesBlk1 = {
        timeline_variables: namesStim,
        repetitions: 3,
        randomize_order: true,
        timeline: [
            {
                type: 'categorize-html',
                stimulus: function(){
                    var html = "";
                    html += "<div style='float: left; margin-right: 250px;'>";
                    html += "<p>Blue group</p><span class='light-keys'><kbd>S</kbd></span></div>";
                    html += "<div style='float: right'>";
                    html += "<p>Green group</p><span class='light-keys'><kbd>L</kbd></span></div>";
                    html += "<p class='italic' style='padding:250px 0 100px 0'><span style='color: "+jsPsych.timelineVariable('color', true)+"'>";
                    html += jsPsych.timelineVariable('target', true)+"</span></p>";
                    return html;
                },
                key_answer: function(){return jsPsych.pluginAPI.convertKeyCharacterToKeyCode(jsPsych.timelineVariable('correctKeyBG', true))},
                choices: ['s', 'l'],
                text_answer: '',
                correct_text: "<p>&nbsp</p>",
                correct_text_duration: 0,
                incorrect_text: "<p><span style='color: red; font-weight: bold'>X</span> press the correct key to continue</p>",
                prompt: function(){ return "<p>&nbsp</p>"; },
                trial_duration: 10000,
                timeout_message: "<p style='color: red;'>please respond faster</p>",
                show_feedback_on_timeout: false,
                force_correct_button_press: true,
                feedback_duration: 600,
                data: {
                    target:       jsPsych.timelineVariable('target'),
                    correctKeyBG: jsPsych.timelineVariable('correctKeyBG'),
                    correctKeyGB: jsPsych.timelineVariable('correctKeyGB'),
                    targetGroup:  jsPsych.timelineVariable('group'),
                    task:         'classNames'
                },      
            }
        ]
    };
    timeline.push(classNamesBlk1);
    
    
    /* Instruction block 2 */
    timeline.push({
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function() {
            var html = "";
            html += "<h1>Categorization task</h1>";
            html += "<p class='justify'>We will ask you to complete once more this task. ";
            html += "Note however that the <span class='emphasize'>group names have swapped places</span>, you will have to: ";
            html += "<p class='justify'>press <span class='light-keys'><kbd>S</kbd></span> if the target name belongs to the ";
            html += "<span id='green'>Green</span> group</br>";
            html += "press <span class='light-keys'><kbd>L</kbd></span> if the target name belongs to the <span id='blue'>Blue</span> group</p>";
            html += "<p class='justify'>Note also that the colors associated with the groups are more similar now. This will make it more difficult ";
            html += "for you to discriminate the groups on the basis of color. That is okay. Remember that in later tasks the color cues will disappear; ";
            html += "thus, it is important that you learn which names go with which groups.</p>";
            html += "<p>press <span class='light-keys'><kbd>spacebar</kbd></span> to continue</p>";
            return html
        },
    });
    
    var classNamesBlk2 = {
        timeline_variables: namesStim,
        repetitions: 3,
        randomize_order: true,
        timeline: [
            {
                type: 'categorize-html',
                stimulus: function(){
                    var html = "";
                    html += "<div style='float: left; margin-right: 250px;'>";
                    html += "<p>Green group</p><span class='light-keys'><kbd>S</kbd></span></div>";
                    html += "<div style='float: right'>";
                    html += "<p>Blue group</p><span class='light-keys'><kbd>L</kbd></span></div>";
                    html += "<p class='italic' style='padding: 250px 0 100px 0'><span style='color: "+jsPsych.timelineVariable('lightColor', true)+"'>";
                    html += jsPsych.timelineVariable('target', true)+"</span></p>";
                    return html;
                },
                key_answer: function(){return jsPsych.pluginAPI.convertKeyCharacterToKeyCode(jsPsych.timelineVariable('correctKeyGB', true))},
                choices: ['s', 'l'],
                text_answer: '',
                correct_text: "<p>&nbsp</p>",
                correct_text_duration: 0,
                incorrect_text: "<p><span style='color: red; font-weight: bold'>X</span> press the correct key to continue</p>",
                prompt: function(){ return "<p>&nbsp</p>"; },
                trial_duration: 10000,
                timeout_message: "<p style='color: red;'>please respond faster</p>",
                show_feedback_on_timeout: false,
                force_correct_button_press: true,
                feedback_duration: 600,
                data: {
                    target:       jsPsych.timelineVariable('target'),
                    correctKeyBG: jsPsych.timelineVariable('correctKeyBG'),
                    correctKeyGB: jsPsych.timelineVariable('correctKeyGB'),
                    targetGroup:  jsPsych.timelineVariable('group'),
                    task:         'classNames'
                },      
            }
        ]
    };
    timeline.push(classNamesBlk2);
    
    /* ~~~~~~ BIAT ~~~~~~ */
    /* BIAT training */
    /* Instructions */
    timeline.push({
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function() {
            var html = "";
            html += "<h1>Categorization task</h1>";
            html += "<p class='justify'>In the following tasks you will be asked to categorize several ";
            html += "<span class='italic'>items</span> into <span class='emphasize'>categories</span>.</p>";
            html += "<p class='justify'>This first task will be just for practice.</p>";
            html += "<p>press <span class='light-keys'><kbd>spacebar</kbd></span> to continue</p>";
            return html
        },
    });
    
    timeline.push(
        genBiatBlock('bird',     ['duck',      'eagle',    'parrot', 'pigeon' ], // FclCat
                     'sweet',    ['chocolate', 'sugar',    'candy',  'dessert'], // FclAtt
                     'reptile',  ['crocodile', 'turtle',   'lizard', 'snake'  ], // UnFclCat
                     'salty',    ['salt',      'chips',    'pickles',  'nuts' ]) // UnFclAtt
    );
    
    /* BIAT: attitude & identification */
    /* Instructions */
    timeline.push({
        type: "html-keyboard-response",
        post_trial_gap: 200,
        choices: [32],
        stimulus: function() {
            var html = "";
            html += "<h1>Categorization task</h1>";
            html += "<p class='justify'>You have completed the practice task.</p>";
            html += "<p class='justify'>Now you will be asked to complete the real categorization tasks.</br>";
            html += "The rules are the same as in the practice task, but the <span class='italic'>items</span>";
            html += " and <span class='emphasize'>categories</span> have changed.</p>";
            html += "<p>press <span class='light-keys'><kbd>spacebar</kbd></span> to continue</p>";
            return html
        },
    });
    
    var catB = "blue group";
    var catG = "green group";
    var attC = "competence";
    var attW = "warmth";
    var itemsC = ['capable',  'skilled', 'organized', 'smart'];
    var itemsW = ['sociable', 'caring',  'friendly',  'kind' ];
    
    var biatBC = genBiatBlock(catB, itemsB, attC, itemsC, catG, itemsG, attW, itemsW, rep = biatRep);
    var biatGC = genBiatBlock(catG, itemsG, attC, itemsC, catB, itemsB, attW, itemsW, rep = biatRep);
    var biatBW = genBiatBlock(catB, itemsB, attW, itemsW, catG, itemsG, attC, itemsC, rep = biatRep);
    var biatGW = genBiatBlock(catG, itemsG, attW, itemsW, catB, itemsB, attC, itemsC, rep = biatRep);
    
    var biatOrderC = _.flattenDeep(_.shuffle(['biatBC', 'biatGC']));
    var biatOrderW = _.flattenDeep(_.shuffle(['biatBW', 'biatGW']));
    var biatOrder  = _.flattenDeep(_.shuffle([biatOrderC, biatOrderW]));
    
    biatOrder.map(function(e) { timeline.push( eval(e) )} );
    
    timeline = _.flattenDeep(timeline);
    /*timeline = [timeline[2]];*/
    console.log(inGrp)
    

    /* Initialise the experiment */
    jsPsych.init({
        timeline: timeline,
        max_load_time: 60*1000,
        exclusions: {
            min_width: 800,
            min_height: 600,
        },
        on_interaction_data_update: function(data) {
            //console.log(JSON.stringify(data)); // focus/blur data
        },
        on_finish: function(data) { 
            $("#jspsych-content").html("<img src='img/loading.gif'>");

            /* Initialize Firebase */
            var config = {
                apiKey: "AIzaSyD4r9uWI4icto61fm2tC9neKdEiOUWzMJ8",
                databaseURL: "https://biatw-68fe6.firebaseio.com/"
            };
            
            firebase.initializeApp(config);
            var database = firebase.database();
            if (id == null) { id = jsPsych.randomization.randomID(15) }; // if no id provided, generate a Firebase id
            

            /* Qualtrics url parameters */
            qlink += "?id=" + id;
            qlink += "&windWidth="    + window.innerWidth  || document.documentElement.clientWidth  || document.body.clientWidth;
            qlink += "&windHeight="   + window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
            qlink += "&screenWidth="  + screen.width  || 0;
            qlink += "&screenHeight=" + screen.height || 0;
            qlink += "&userAgent="    + navigator.userAgent;
            qlink += "&totalTime="    + jsPsych.totalTime();
            
            /* jsPsych: add data to every trial */
            jsPsych.data.addProperties({
                id:          id,
                hghGrp:      hghGrp,
                inGrp:       inGrp, // "G", "B", "O"
                status:      status, // codes for condition: "H", "L", "O"
                hghFstSta:   hghFst,
                hghFstDscrp: hghFstDscrp,
                biatOrder:   biatOrder.join().replace(/biat/g, '').replace(/,/g, ''),
                itemsB:      itemsB.join(),
                itemsG:      itemsG.join(),
                itemsO:      [itemsGF[0], itemsGM[0], itemsBF[0], itemsBM[0]].join()
            });
           
            if(jsPsych.data.getURLVariable("displayData")) {jsPsych.data.displayData()};
            
            var dataAll = data.csv();
            var dataClassNames = data.filter({task: 'classNames'}).csv();
            var dataBiat = data.filter({task: 'biat'}).csv();

            /* Send data to Firebase and redirect to Qualtrics */
            database.ref("IP/" + id + "/").update({dataAll}).then(function() { console.log("dataAll sent!") });
            database.ref("IP/" + id + "/").update({dataClassNames}).then(function() { console.log("dataClassNames sent!") });
            database.ref("IP/" + id + "/").update({dataBiat}).then(function() { 
                window.location.href = qlink; // redirect to qualtrics
                //jsPsych.data.displayData();
            });
        }
    });
    </script>
</head>
<body>
</body>
</html>
